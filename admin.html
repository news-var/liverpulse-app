<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–õ—ñ–≤–µ—Ä–ø—É–ª—å—Å ‚Äì –ê–¥–º—ñ–Ω</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="max-w-xl mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 space-y-6">
        <h1 class="text-xl sm:text-2xl font-bold">üì¢ –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</h1>

        <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è -->
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-1">API URL</label>
                <input id="apiUrl" type="text"
                       value="https://liverpulse-worker.liverpulse.workers.dev"
                       class="w-full border px-3 py-2 rounded-lg text-sm">
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Admin Secret</label>
                <input id="adminKey" type="password" placeholder="–í–∞—à ADMIN_SECRET"
                       class="w-full border px-3 py-2 rounded-lg text-sm">
            </div>
        </div>

        <hr class="my-2">

        <!-- Broadcast -->
        <section class="space-y-2">
            <h2 class="text-lg sm:text-xl font-bold">üì£ Broadcast (–≤—Å—ñ–º)</h2>
            <textarea id="broadcastMsg" rows="3"
                      placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö..."
                      class="w-full border px-3 py-2 rounded-lg text-sm"></textarea>
            <button onclick="sendBroadcast()"
                    class="w-full sm:w-auto bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700">
                –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—Å—ñ–º
            </button>
        </section>

        <hr class="my-2">

        <!-- –ö–û–ù–ö–†–ï–¢–ù–ò–ô –Æ–ó–ï–† -->
        <section class="space-y-3">
            <div>
                <h2 class="text-lg sm:text-xl font-bold mb-1">üë§ –î—ñ—ó –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º —é–∑–µ—Ä–æ–º</h2>
                <p class="text-xs sm:text-sm text-gray-500">
                    –ú–æ–∂–Ω–∞ –≤–∫–∞–∑–∞—Ç–∏ <span class="font-semibold">Telegram User ID</span> –∞–±–æ <span class="font-semibold">@username</span>.
                </p>
            </div>

            <input id="userId" type="text"
                   placeholder="User ID –∞–±–æ @username"
                   class="w-full border px-3 py-2 rounded-lg text-sm">

            <textarea id="userMsg" rows="3"
                      placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ü—å–æ–º—É —é–∑–µ—Ä—É..."
                      class="w-full border px-3 py-2 rounded-lg text-sm"></textarea>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button onclick="sendToUser()"
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">
                    ‚úâÔ∏è –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                </button>

                <button onclick="fetchUserBets()"
                        class="w-full bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-700">
                    üìã –°—Ç–∞–≤–∫–∏ —ñ —Ä–µ—Ñ–∫–∏ —é–∑–µ—Ä–∞
                </button>

                <button onclick="blockUser(true)"
                        class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-orange-700">
                    üîí –ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø
                </button>

                <button onclick="blockUser(false)"
                        class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-800">
                    ‚úÖ –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø
                </button>
                
                <button onclick="recalcUser()"
                        class="w-full sm:col-span-2 bg-blue-500 text-white py-2 px-3 rounded text-sm font-semibold hover:bg-blue-600">
                  üîÅ –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ —Å—Ç–∞–≤–∫–∏ —é–∑–µ—Ä–∞
                </button>

                <button onclick="resetUserResults()"
                        class="w-full sm:col-span-2 bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600">
                    ‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —é–∑–µ—Ä–∞
                </button>

                <button onclick="deleteUser()"
                        class="w-full sm:col-span-2 bg-red-900 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-950">
                    üóëÔ∏è –ü–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç–∏ —é–∑–µ—Ä–∞ –∑ —Ä–µ–π—Ç–∏–Ω–≥—É
                </button>
            </div>

            <div id="userBetsResult"
                 class="hidden whitespace-pre-wrap text-[11px] sm:text-xs bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-[320px] overflow-auto"></div>

            <!-- –†—É—á–Ω–∏–π –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞–≤–æ–∫ -->
            <div class="mt-4 border-t pt-3 space-y-3">
                <h3 class="text-sm sm:text-base font-semibold">‚ôªÔ∏è –†—É—á–Ω–∏–π –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫</h3>

                <div class="flex flex-col sm:flex-row gap-2">
                    <input id="recalcBetId"
                           type="number"
                           class="border px-3 py-2 rounded-lg text-sm w-full sm:w-40"
                           placeholder="ID —Å—Ç–∞–≤–∫–∏">
                    <button onclick="recalcBet()"
                            class="w-full sm:w-auto bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700">
                        –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—Ç–∞–≤–∫—É
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-2">
                    <input id="recalcMatchId"
                           type="number"
                           class="border px-3 py-2 rounded-lg text-sm w-full sm:w-40"
                           placeholder="ID –º–∞—Ç—á—É">
                    <button onclick="recalcMatch()"
                            class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">
                        –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ —Å—Ç–∞–≤–∫–∏ –º–∞—Ç—á—É
                    </button>
                </div>

                <pre id="recalcOutput"
                     class="bg-gray-900 text-green-300 text-[10px] sm:text-xs p-3 rounded-lg max-h-[200px] overflow-auto"></pre>
            </div>
        </section>


        <hr class="my-2">

        <!-- –°–õ–£–ñ–ë–û–í–Ü –î–Ü–á -->
        <section class="space-y-4">
            <h2 class="text-lg sm:text-xl font-bold">‚öô –°–ª—É–∂–±–æ–≤—ñ –¥—ñ—ó</h2>

            <!-- –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤ (–∑ –∫–µ—à–∞) -->
            <div class="space-y-1">
                <h3 class="text-xs font-semibold text-gray-600 uppercase tracking-wide">
                    –ú–∞—Ç—á—ñ (–∑ –∫–µ—à–∞, –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤)
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button onclick="refreshMatches('auto')"
                            class="w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700">
                        üîÑ –û–Ω–æ–≤–∏—Ç–∏ –º–∞—Ç—á—ñ (–æ—Å–Ω–æ–≤–Ω—ñ —Ç—É—Ä–Ω—ñ—Ä–∏)
                    </button>

                    <button onclick="refreshMatches('extra')"
                            class="w-full bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-teal-700">
                        üîÑ –û–Ω–æ–≤–∏—Ç–∏ –º–∞—Ç—á—ñ (–¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ç—É—Ä–Ω—ñ—Ä–∏)
                    </button>
                </div>
            </div>

            <!-- –§–æ—Ä—Å-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ -->
            <div class="space-y-1">
                <h3 class="text-xs font-semibold text-gray-600 uppercase tracking-wide">
                    –§–æ—Ä—Å –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ (–ø—Ä—è–º—ñ –∑–∞–ø–∏—Ç–∏ –≤ Odds API)
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button onclick="forceOdds('auto')"
                            class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700">
                        üìä –§–æ—Ä—Å-–∫–æ–µ—Ñ. (–æ—Å–Ω–æ–≤–Ω—ñ —Ç—É—Ä–Ω—ñ—Ä–∏)
                    </button>

                    <button onclick="forceOdds('extra')"
                            class="w-full bg-fuchsia-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-fuchsia-700">
                        üèÜ –§–æ—Ä—Å-–∫–æ–µ—Ñ. (–¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ç—É—Ä–Ω—ñ—Ä–∏)
                    </button>
                </div>
                <p class="text-[11px] text-gray-500">
                    –ö–æ–∂–µ–Ω —Ñ–æ—Ä—Å —Ä–æ–±–∏—Ç—å –∫—ñ–ª—å–∫–∞ –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ Odds API. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ, –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ –æ–Ω–æ–≤–∏—Ç–∏ –ª—ñ–Ω—ñ—é.
                </p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button onclick="sendReminderToSelf()"
                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700">
                    ‚è∞ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è (upcoming)
                </button>

                <button onclick="resetRating()"
                        class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-orange-700">
                    ‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ —É—Å—ñ–º
                </button>
            </div>
        </section>

        <hr class="my-2">

        <!-- üéØ –†–£–ß–ù–ê–Ø –†–ê–ë–û–¢–ê –° –ú–ê–¢–ß–ê–ú–ò -->
        <section class="space-y-4">
            <h2 class="text-lg sm:text-xl font-bold">üéØ –†—É—á–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑ –º–∞—Ç—á–∞–º–∏</h2>
    
            <div class="space-y-2">
                <p class="text-xs text-gray-600">
                    –Ø–∫—â–æ —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á—É –∞–±–æ —Å—Ç–∞–≤–∫–∏ –Ω–µ –æ–Ω–æ–≤–∏–ª–∏—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ü—ñ —Ñ—É–Ω–∫—Ü—ñ—ó.
                    –ú–∞—Ç—á—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è –∫–æ–∂–Ω—ñ 6 —Ö–≤–∏–ª–∏–Ω.
                </p>

                <div class="flex flex-col sm:flex-row gap-2">
                    <input 
                        id="manualMatchId"
                        type="number"
                        class="border px-3 py-2 rounded-lg text-sm w-full sm:w-40"
                        placeholder="ID –º–∞—Ç—á—É"
                    />
                    <button 
                        onclick="manualCheckMatchStatus()"
                        class="w-full sm:w-auto bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-cyan-700"
                    >
                        üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á—É
                    </button>
                    <button 
                        onclick="manualSettleAllMatchBets()"
                        class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700"
                    >
                        üìä –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—Ç–∞–≤–∫–∏ –º–∞—Ç—á—É
                    </button>
                </div>

                <div id="manualStatusOutput"
                     class="hidden text-xs bg-blue-50 border border-blue-200 rounded-lg p-3 whitespace-pre-wrap max-h-[300px] overflow-auto font-mono">
                </div>

                <div id="manualSettleOutput"
                     class="hidden text-xs bg-green-50 border border-green-200 rounded-lg p-3 whitespace-pre-wrap max-h-[300px] overflow-auto font-mono">
                </div>
            </div>
        </section>

        <hr class="my-2">

        <!-- –ï–ö–°–ü–û–†–¢ –°–¢–ê–í–û–ö + –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <section class="space-y-3">
            <h2 class="text-lg sm:text-xl font-bold">üìÑ –ï–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞–≤–æ–∫ —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

            <div class="space-y-2">
                <label class="block text-xs font-semibold mb-1">
                    –î—ñ–∞–ø–∞–∑–æ–Ω –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É (–¥–Ω—ñ–≤)
                </label>
                <input id="daysRange" type="number" min="1" value="30"
                       class="w-full border px-3 py-1.5 rounded-lg text-xs">
                <button onclick="downloadAllBets()"
                        class="w-full bg-sky-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-sky-700">
                    ‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV –∑—ñ —Å—Ç–∞–≤–∫–∞–º–∏
                </button>
            </div>

            <div class="space-y-2">
                <h3 class="text-base sm:text-lg font-semibold">üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <button onclick="loadStats()"
                        class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-black">
                    –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                </button>
                <div id="statsBox"
                     class="text-xs bg-gray-50 border rounded-lg p-2 min-h-[48px]">
                    –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
                </div>
            </div>
        </section>

        <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–û–î–Ü–ô -->
        <div id="result" class="mt-2 p-3 rounded-lg text-sm hidden"></div>
    </div>
</div>

<script>
    function showResult(msg, type) {
        const el = document.getElementById('result');
        el.textContent = msg;
        el.className =
            'mt-2 p-3 rounded-lg text-sm ' +
            (type === 'success'
                ? 'bg-green-100 text-green-800'
                : 'bg-red-100 text-red-800');
        el.classList.remove('hidden');
    }

    function formatDateTime(str) {
        if (!str) return '';
        const d = new Date(str);
        return d.toLocaleString('uk-UA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ---------- Broadcast ----------
    async function sendBroadcast() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const message = document.getElementById('broadcastMsg').value.trim();

        if (!message) {
            showResult('–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!', 'error');
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/api/admin/broadcast`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({ message })
            });

            const data = await response.json();

            if (response.ok) {
                showResult(`‚úÖ –ù–∞–¥—ñ—Å–ª–∞–Ω–æ ${data.sent} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º`, 'success');
                document.getElementById('broadcastMsg').value = '';
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Send to user ----------
    async function sendToUser() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const target = document.getElementById('userId').value.trim();
        const message = document.getElementById('userMsg').value.trim();

        if (!target || !message) {
            showResult('–í–≤–µ–¥—ñ—Ç—å User ID / @username —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!', 'error');
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/api/admin/send-user`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({ target, message })
            });

            const data = await response.json();

            if (response.ok) {
                showResult(`‚úÖ –ù–∞–¥—ñ—Å–ª–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É ${target}`, 'success');
                document.getElementById('userMsg').value = '';
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤ (–∑ –∫–µ—à–∞) ----------
    async function refreshMatches(mode) {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();

        try {
            const response = await fetch(`${apiUrl}/api/force-update?mode=${encodeURIComponent(mode)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                }
            });

            const data = await response.json();

            if (response.ok) {
                showResult(`‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤ (${mode}) –≤–∏–∫–æ–Ω–∞–Ω–æ`, 'success');
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- –§–æ—Ä—Å –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ (–ø—Ä—è–º–æ –≤ Odds API) ----------
    async function forceOdds(mode) {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();

        try {
            const response = await fetch(`${apiUrl}/api/admin/force-odds?mode=${encodeURIComponent(mode)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                }
            });

            const data = await response.json();

            if (response.ok && data.ok) {
                showResult(`‚úÖ –§–æ—Ä—Å-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ (${mode})`, 'success');
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Reminder (upcoming) ----------
    async function sendReminderToSelf() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const userField = document.getElementById('userId').value.trim();

        try {
            const params = userField
                ? `?userId=${encodeURIComponent(userField)}`
                : '';
            const response = await fetch(`${apiUrl}/api/notify-upcoming${params}`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            const data = await response.json();

            if (response.ok && data.ok) {
                showResult('‚úÖ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.message || data.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Reset all ratings ----------
    async function resetRating() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();

        if (!confirm('–¢–æ—á–Ω–æ —Å–∫–∏–Ω—É—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ —É—Å—ñ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º?')) return;

        try {
            const response = await fetch(`${apiUrl}/api/reset-rating`, {
                method: 'POST',
                headers: { 'X-Admin-Key': adminKey }
            });

            const data = await response.json();

            if (response.ok) {
                showResult(`‚úÖ –†–µ–π—Ç–∏–Ω–≥ —Å–∫–∏–Ω—É—Ç–æ ${data.users} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º`, 'success');
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Delete User (full remove) ----------
    async function deleteUser() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const target = document.getElementById('userId').value.trim();

        if (!target) {
            showResult('–í–≤–µ–¥—ñ—Ç—å User ID –∞–±–æ @username!', 'error');
            return;
        }

        if (!confirm(`–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —é–∑–µ—Ä–∞ ${target} –∑ —Ä–µ–π—Ç–∏–Ω–≥—É –Ω–∞–∑–∞–≤–∂–¥–∏?`)) {
            return;
        }

        try {
            const resp = await fetch(`${apiUrl}/api/admin/delete-user`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey,
                },
                body: JSON.stringify({ target }),
            });

            const data = await resp.json();

            if (resp.ok && data.ok) {
                showResult(`‚úÖ –Æ–∑–µ—Ä–∞ ${data.username} –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–µ–Ω–æ`, 'success');
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || 'Unknown error'}`, 'error');
            }
        } catch (e) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${e.message}`, 'error');
        }
    }

    async function recalcUser() {
        const target = document.getElementById("userId").value.trim();

        if (!target) {
            showResult("–í–∫–∞–∂—ñ—Ç—å User ID –∞–±–æ @username –¥–ª—è –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–∫—É", "error");
            return;
        }

        try {
            const { ok, data } = await adminRequest(
                "/api/admin/recalc-user",
                "POST",
                { target }
            );

            if (!ok || !data.ok) {
                showResult(
                    "–ü–æ–º–∏–ª–∫–∞: " + (data.error || "unknown"),
                    "error"
                );
                return;
            }

            showResult(
                `‚úÖ –Æ–∑–µ—Ä ${data.username} –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–∏–π. ` +
                `–ù–æ–≤–∏–π –±–∞–ª–∞–Ω—Å: ${data.newBalance}. ` +
                `–°—Ç–∞–≤–æ–∫: ${data.totalBets}, –≤–∏–≥—Ä–∞—à–Ω–∏—Ö: ${data.wonBets}, ` +
                `–ø–æ–≤–µ—Ä–Ω–µ–Ω—å: ${data.refundBets}, —Ä–µ—Ñ–æ–∫: ${data.referralCount}`,
                "success"
            );
        } catch (e) {
            console.error(e);
            showResult("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ /api/admin/recalc-user", "error");
        }
    }



    
    // ---------- Fetch user bets ----------
    async function fetchUserBets() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const target = document.getElementById('userId').value.trim();
        const box = document.getElementById('userBetsResult');

        if (!target) {
            showResult('–í–∫–∞–∂—ñ—Ç—å User ID / @username –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å—Ç–∞–≤–æ–∫', 'error');
            return;
        }

        box.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        box.classList.remove('hidden');

        try {
            const response = await fetch(
                `${apiUrl}/api/admin/user-bets?target=${encodeURIComponent(target)}`,
                {
                    headers: { 'X-Admin-Key': adminKey }
                }
            );

            const data = await response.json();

            if (!response.ok) {
                box.textContent = `–ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`;
                return;
            }

            let text = `–Æ–∑–µ—Ä: ${data.user.username} (id: ${data.user.id})\n\n`;

            if (!data.bets.length) {
                text += '–°—Ç–∞–≤–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ\n';
            } else {
                const lines = data.bets.map(b => {
                    const matchTitle = b.match_home && b.match_away
                        ? `${b.match_home} ‚Äì ${b.match_away}`
                        : `–ú–∞—Ç—á #${b.match_id}`;
                    const resScore = (b.home_score != null && b.away_score != null)
                        ? ` | –†–∞—Ö—É–Ω–æ–∫: ${b.home_score}:${b.away_score}`
                        : '';
                    const statusMap = {
                        pending: '–æ—á—ñ–∫—É–≤–∞–Ω–Ω—è',
                        won: '–≤–∏–≥—Ä–∞—à',
                        lost: '–ø—Ä–æ–≥—Ä–∞—à',
                        refund: '–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è'
                    };
                    const status = statusMap[b.status] || b.status;

                    return `#${b.id} | ${formatDateTime(b.created_at)} | ${matchTitle}` +
                        (b.competition ? ` (${b.competition})` : '') +
                        `\n  –°—Ç–∞–≤–∫–∞: ${b.bet_type} ‚Äì ${b.selection}, —Å—Ç–∞—Ç—É—Å: ${status}` +
                        `\n  –ö–æ–µ—Ñ.: ${b.odds}, —Å—É–º–∞: ${b.stake}, –ø–æ—Ç–µ–Ω—Ü. –≤–∏–≥—Ä–∞—à: ${b.potential_win}` +
                        (b.user_points_after != null ? `, –±–∞–ª–∞–Ω—Å –ø—ñ—Å–ª—è: ${b.user_points_after}` : '') +
                        resScore +
                        `\n`;
                });

                text += lines.join('\n');
            }

            // ==== –±–ª–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ ====
            const refs = Array.isArray(data.referrals) ? data.referrals : [];
            const refCount = data.referral_count != null
                ? data.referral_count
                : refs.length;

            text += `\n–†–µ—Ñ–µ—Ä–∞–ª—ñ–≤: ${refCount}\n`;

            if (refs.length) {
                refs.forEach((r, idx) => {
                    const nick = r.invited_username || '–±–µ–∑ –Ω—ñ–∫—É';
                    const id = r.invited_id != null ? r.invited_id : '‚Äî';
                    const status = r.rewarded ? '–±–æ–Ω—É—Å –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ' : '–±–µ–∑ –±–æ–Ω—É—Å—É';
                    const dt = r.created_at ? `, –¥–∞—Ç–∞: ${formatDateTime(r.created_at)}` : '';
                    text += `${idx + 1}. ${nick} (id: ${id}), ${status}${dt}\n`;
                });
            }

            box.textContent = text;
        } catch (error) {
            box.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
    }


    // ---------- Download all bets CSV ----------
    async function downloadAllBets() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const daysField = document.getElementById('daysRange');
        const daysValue = daysField ? Number(daysField.value) : NaN;
        const days = Number.isFinite(daysValue) && daysValue > 0 ? daysValue : 30;

        try {
            const response = await fetch(`${apiUrl}/api/admin/all-bets?days=${days}`, {
                headers: { 'X-Admin-Key': adminKey }
            });

            const payload = await response.json();

            if (!response.ok) {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${payload.error || 'unknown'}`, 'error');
                return;
            }

            const data = payload.data || [];

            if (!data.length) {
                showResult(`–ù–µ–º–∞—î —Å—Ç–∞–≤–æ–∫ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ ${payload.days} –¥–Ω—ñ–≤`, 'error');
                return;
            }

            const header = [
                'id','user_id','username','created_at',
                'match','competition','score',
                'bet_type','selection','status',
                'odds','stake','potential_win','user_points_after'
            ].join(';') + '\n';

            const lines = data.map(b => {
                const matchTitle = b.match_home && b.match_away
                    ? `${b.match_home} ‚Äì ${b.match_away}`
                    : `–ú–∞—Ç—á #${b.match_id}`;
                const score = (b.home_score != null && b.away_score != null)
                    ? `${b.home_score}:${b.away_score}`
                    : '';
                return [
                    b.id,
                    b.user_id,
                    (b.username || '').replace(/;/g, ','),
                    formatDateTime(b.created_at),
                    matchTitle.replace(/;/g, ','),
                    (b.competition || '').replace(/;/g, ','),
                    score,
                    b.bet_type,
                    b.selection,
                    b.status,
                    b.odds,
                    b.stake,
                    b.potential_win,
                    b.user_points_after ?? ''
                ].join(';');
            });

            const content = header + lines.join('\n');
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const ts = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            a.href = url;
            a.download = `liverpulse_bets_last_${payload.days}_days_${ts}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showResult(`‚úÖ CSV –∑—ñ —Å—Ç–∞–≤–∫–∞–º–∏ (–æ—Å—Ç–∞–Ω–Ω—ñ ${payload.days} –¥–Ω—ñ–≤) –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Block / unblock user ----------
    async function blockUser(block) {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const target = document.getElementById('userId').value.trim();

        if (!target) {
            showResult('–í–∫–∞–∂—ñ—Ç—å User ID / @username –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è', 'error');
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/api/admin/block-user`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({ target, block })
            });

            const data = await response.json();

            if (response.ok && data.ok) {
                showResult(
                    block
                        ? `‚úÖ –Æ–∑–µ—Ä–∞ ${data.username} –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ`
                        : `‚úÖ –Æ–∑–µ—Ä–∞ ${data.username} —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ`,
                    'success'
                );
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Reset one user's results ----------
    async function resetUserResults() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const target = document.getElementById('userId').value.trim();

        if (!target) {
            showResult('–í–∫–∞–∂—ñ—Ç—å User ID / @username –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤', 'error');
            return;
        }

        if (!confirm('–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Å—Ç–∞–≤–∫–∏ —ñ —Å–∫–∏–Ω—É—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ —Ü—å–æ–≥–æ —é–∑–µ—Ä–∞?')) return;

        try {
            const response = await fetch(`${apiUrl}/api/admin/reset-user`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({ target })
            });

            const data = await response.json();

            if (response.ok && data.ok) {
                showResult(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —é–∑–µ—Ä–∞ ${data.username} —Å–∫–∏–Ω—É—Ç–æ`, 'success');
            } else {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`, 'error');
            }
        } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        }
    }

    // ---------- Admin helper ----------
    async function adminRequest(path, method = 'GET', body) {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();

        const resp = await fetch(`${apiUrl}${path}`, {
            method,
            headers: {
                'Content-Type': 'application/json',
                'X-Admin-Key': adminKey
            },
            body: body ? JSON.stringify(body) : undefined
        });

        let data;
        try {
            data = await resp.json();
        } catch (e) {
            data = { error: 'Invalid JSON' };
        }
        return { ok: resp.ok, data };
    }

    // ---------- Recalc ONE bet ----------
    async function recalcBet() {
        const betId = Number(document.getElementById('recalcBetId').value);
        const out = document.getElementById('recalcOutput');

        if (!betId) {
            out.textContent = '–í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π ID —Å—Ç–∞–≤–∫–∏';
            return;
        }

        out.textContent = '–ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞–≤–∫–∏...';

        const { ok, data } = await adminRequest('/api/admin/recalc-bet', 'POST', { betId });

        if (!ok) {
            out.textContent = `–ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`;
            return;
        }

        out.textContent = JSON.stringify(data, null, 2);
        showResult('‚úÖ –°—Ç–∞–≤–∫—É –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–æ', 'success');
    }

    // ---------- Recalc ALL bets of match ----------
    async function recalcMatch() {
        const matchId = Number(document.getElementById('recalcMatchId').value);
        const out = document.getElementById('recalcOutput');

        if (!matchId) {
            out.textContent = '–í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π ID –º–∞—Ç—á—É';
            return;
        }

        out.textContent = '–ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞–≤–æ–∫ –º–∞—Ç—á—É...';

        const { ok, data } = await adminRequest('/api/admin/recalc-match', 'POST', { matchId });

        if (!ok) {
            out.textContent = `–ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`;
            return;
        }

        out.textContent = JSON.stringify(data, null, 2);
        showResult('‚úÖ –°—Ç–∞–≤–∫–∏ –º–∞—Ç—á—É –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–æ', 'success');
    }

    // ==========================================
    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–î–ú–ò–ù–ö–ò
    // –î–æ–±–∞–≤—å —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–Ω–µ—Ü <script> –±–ª–æ–∫–∞ –≤ admin.html
    // ==========================================

    // ---------- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á–∞ –≤—Ä—É—á–Ω—É—é ----------
    async function manualCheckMatchStatus() {
        const matchId = Number(document.getElementById('manualMatchId').value);
        const out = document.getElementById('manualStatusOutput');

        if (!matchId) {
            showResult('–í–∫–∞–∂—ñ—Ç—å ID –º–∞—Ç—á—É', 'error');
            return;
        }

        out.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç—á—É...';
        out.classList.remove('hidden');

        try {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();

            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ç—á–µ
            const resp = await fetch(`${apiUrl}/api/admin/match-info?id=${matchId}`, {
                headers: { 'X-Admin-Key': adminKey }
            });

            if (!resp.ok) {
                out.textContent = `–ü–æ–º–∏–ª–∫–∞: ${resp.status}`;
                return;
            }

            const data = await resp.json();

            if (!data.ok) {
                out.textContent = `–ú–∞—Ç—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`;
                return;
            }

            const match = data.match;
            const now = new Date();
            const matchTime = new Date(match.match_date);
            const minutesUntilStart = (matchTime - now) / 60000;
            const minutesSinceStart = (now - matchTime) / 60000;

            let info = `
    üìå –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø –ü–†–û –ú–ê–¢–ß
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ú–∞—Ç—á: ${match.home_team} vs ${match.away_team}
    ID: ${match.id}
    –î–∞—Ç–∞: ${formatDateTime(match.match_date)}
    –°—Ç–∞—Ç—É—Å: ${match.status}
    –¢—É—Ä–Ω—ñ—Ä: ${match.competition || '‚Äî'}

    `;

            if (match.status === 'upcoming') {
                info += `‚è≥ –ú–∞—Ç—á —â–µ –ù–ï –ø–æ—á–∞–≤—Å—è\n`;
                info += `   –î–æ –ø–æ—á–∞—Ç–∫—É: ${minutesUntilStart.toFixed(0)} —Ö–≤–∏–ª–∏–Ω\n`;
            } else if (match.status === 'locked') {
                info += `üîí –ú–∞—Ç—á –∑–∞—Ä–∞–∑ –ó–ê–ö–†–ò–¢–ò–ô (—Å—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä–∏—Ç—ñ)\n`;
            } else if (match.status === 'live') {
                info += `üî¥ –ú–∞—Ç—á –í–Ü–î–ë–£–í–ê–Ñ–¢–¨–°–Ø\n`;
                info += `   –ô–¥–µ ${minutesSinceStart.toFixed(0)} —Ö–≤–∏–ª–∏–Ω\n`;
                if (match.home_score != null && match.away_score != null) {
                    info += `   –†–∞—Ö—É–Ω–æ–∫: ${match.home_score}:${match.away_score}\n`;
                } else {
                    info += `   ‚ö†Ô∏è –†–∞—Ö—É–Ω–∫—É —â–µ –Ω–µ–º–∞—î —É —Å–∏—Å—Ç–µ–º—ñ\n`;
                }
            } else if (match.status === 'finished') {
                info += `‚úÖ –ú–∞—Ç—á –ó–ê–í–ï–†–®–ï–ù–û\n`;
                if (match.home_score != null && match.away_score != null) {
                    info += `   –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫: ${match.home_score}:${match.away_score}\n`;
                } else {
                    info += `   ‚ö†Ô∏è –†–∞—Ö—É–Ω–∫—É –Ω–µ–º–∞—î\n`;
                }
            }

            out.textContent = info;

        } catch (error) {
            out.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
    }


    // ---------- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å—Ç–∞–≤–∫–∏ –º–∞—Ç—á–∞ –≤—Ä—É—á–Ω—É—é ----------
    async function manualSettleAllMatchBets() {
      const matchId = Number(document.getElementById('manualMatchId').value);
      const out = document.getElementById('manualSettleOutput');

      if (!matchId) {
        showResult('–í–∫–∞–∂—ñ—Ç—å ID –º–∞—Ç—á—É', 'error');
        return;
      }

      out.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç—á—É —Ç–∞ —Ä–∞—Ö—É–Ω–∫—É...';
      out.classList.remove('hidden');

      try {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();

        // 1) –ü–æ–ª—É—á–∞–µ–º –º–∞—Ç—á
        const infoResp = await fetch(`${apiUrl}/api/admin/match-info?id=${matchId}`, {
          headers: { 'X-Admin-Key': adminKey }
        });

        if (!infoResp.ok) {
          out.textContent = `–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –º–∞—Ç—á—É`;
          return;
        }

        const infoData = await infoResp.json();
        if (!infoData.ok) {
          out.textContent = `–ú–∞—Ç—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`;
          return;
        }

        const match = infoData.match;

        // 2) –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞—Ö—É–Ω–æ–∫ (–≤ –ë–î –º–∞—Ç—á–∞)
        if (match.home_score == null || match.away_score == null) {
          out.textContent = `
    ‚ùå –ü–û–ú–ò–õ–ö–ê: –£ –º–∞—Ç—á—É –Ω–µ–º–∞—î —Ä–∞—Ö—É–Ω–∫—É –≤ —Å–∏—Å—Ç–µ–º—ñ!

    –ú–∞—Ç—á: ${match.home_team} vs ${match.away_team}
    –°—Ç–∞—Ç—É—Å: ${match.status}
    –î–∞—Ç–∞ –º–∞—Ç—á—É: ${formatDateTime(match.match_date)}

    üîß –©–û –†–û–ë–ò–¢–ò:
    1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –º–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—ñ
    2. –ù–∞—Ç–∏—Å–Ω–∏ "üîÑ –û–Ω–æ–≤–∏—Ç–∏ –º–∞—Ç—á—ñ (–æ—Å–Ω–æ–≤–Ω—ñ —Ç—É—Ä–Ω—ñ—Ä–∏)" –≤ Service Actions
    3. –ó–∞—á–µ–∫–∞–π 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    4. –°–ø—Ä–æ–±—É–π –∑–Ω–æ–≤—É –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ "üìä –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—Ç–∞–≤–∫–∏ –º–∞—Ç—á—É"

    –Ø–∫—â–æ —Ä–∞—Ö—É–Ω–∫—É –í–°–ï –ï–©–ï –Ω–µ–º–∞—î - –º–∞—Ç—á —â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –≤ Odds API.
          `;
          return;
        }

        // 3) –ï—Å—Ç—å —Ä–∞—Ö—É–Ω–æ–∫ ‚Äî –≤—ã–∑—ã–≤–∞–µ–º API –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
        const settleResp = await fetch(`${apiUrl}/api/admin/settle-match-manual`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({
            matchId,
            homeScore: match.home_score,
            awayScore: match.away_score
          })
        });

        const settleData = await settleResp.json();

        if (settleResp.ok && settleData.ok) {
          out.textContent = `
    ‚úÖ –ú–ê–¢–ß –†–û–ó–†–ê–•–û–í–ê–ù–û –í–†–£–ß–ù–£

    –ú–∞—Ç—á: ${settleData.match}
    –†–∞—Ö—É–Ω–æ–∫: ${match.home_score}:${match.away_score}

    üìä –†–ï–ó–£–õ–¨–¢–ê–¢–ò:
      ‚Ä¢ –í—Å—å–æ–≥–æ —Å—Ç–∞–≤–æ–∫ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ: ${settleData.betsProcessed}
      ‚Ä¢ –í—Å—å–æ–≥–æ –±–∞–ª—ñ–≤ –≤–∏–¥–∞–Ω–æ —é–∑–µ—Ä–∞–º: ${settleData.totalCredited}

    ${settleData.message}
          `;
          showResult(`‚úÖ ${settleData.betsProcessed} —Å—Ç–∞–≤–æ–∫ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ, ${settleData.totalCredited} –±–∞–ª—ñ–≤ –≤–∏–¥–∞–Ω–æ`, 'success');
        } else {
          out.textContent = `–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É: ${settleData.error || '–Ω–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'}`;
        }

      } catch (error) {
        out.textContent = `–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É: ${error.message}`;
      }
    }


    // ---------- Helper —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã ----------
    function formatDateTime(str) {
        if (!str) return '';
        const d = new Date(str);
        return d.toLocaleString('uk-UA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    
    // ---------- Dashboard stats ----------
    async function loadStats() {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const adminKey = document.getElementById('adminKey').value.trim();
        const box = document.getElementById('statsBox');

        if (!box) return;

        box.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';

        try {
            const response = await fetch(`${apiUrl}/api/admin/stats`, {
                headers: { 'X-Admin-Key': adminKey }
            });

            const data = await response.json();

            if (!response.ok) {
                box.textContent = `–ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`;
                return;
            }

            box.innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-[11px] sm:text-sm">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-2">
                        <div class="font-semibold">–Æ–∑–µ—Ä—ñ–≤</div>
                        <div class="text-lg sm:text-xl font-bold">${data.totalUsers}</div>
                        <div class="text-[11px] text-gray-500">–ê–∫—Ç–∏–≤–Ω–∏—Ö: ${data.activeUsers}</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                        <div class="font-semibold">–°—Ç–∞–≤–æ–∫</div>
                        <div class="text-lg sm:text-xl font-bold">${data.totalBets}</div>
                        <div class="text-[11px] text-gray-500">Winrate: ${data.winRate}%</div>
                    </div>
                    <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-2">
                        <div class="font-semibold">–°—É–º–∞ —Å—Ç–∞–≤–æ–∫</div>
                        <div class="text-lg sm:text-xl font-bold">${data.totalStake.toFixed(0)}</div>
                        <div class="text-[11px] text-gray-500">–ü–æ—Ç–µ–Ω—Ü. –≤–∏–≥—Ä–∞—à: ${data.totalPotentialWin.toFixed(0)}</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                        <div class="font-semibold">–í–∏–ø–ª–∞—Ç–∏ –ø–æ –≤–∏–≥—Ä–∞—à–∞–º</div>
                        <div class="text-lg sm:text-xl font-bold">${data.sumWonPayout.toFixed(0)}</div>
                        <div class="text-[11px] text-gray-500">
                            –í–∏–≥—Ä–∞—à—ñ–≤ / –ü–æ–≤–µ—Ä–Ω–µ–Ω—å: ${data.totalWonBets} / ${data.totalRefundBets}
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            box.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
    }
</script>
</body>
</html>











