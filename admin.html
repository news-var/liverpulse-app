<!DOCTYPE html>
<html>
<head>
    <title>–õ—ñ–≤–µ—Ä–ø—É–ª—å—Å - –ê–¥–º—ñ–Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-6">üì¢ –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</h1>
        
        <div class="mb-6">
            <label class="block font-bold mb-2">API URL:</label>
            <input id="apiUrl" type="text" value="https://liverpulse-worker.liverpulse.workers.dev" 
                class="w-full border px-3 py-2 rounded">
        </div>

        <div class="mb-6">
            <label class="block font-bold mb-2">Admin Secret:</label>
            <input id="adminKey" type="password" placeholder="–í–∞—à ADMIN_SECRET" 
                class="w-full border px-3 py-2 rounded">
        </div>

        <hr class="my-6">

        <!-- Broadcast -->
        <h2 class="text-xl font-bold mb-4">üì£ Broadcast (–≤—Å—ñ–º)</h2>
        <textarea id="broadcastMsg" rows="4" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö..." 
            class="w-full border px-3 py-2 rounded mb-3"></textarea>
        <button onclick="sendBroadcast()" 
            class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">
            –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—Å—ñ–º
        </button>

        <hr class="my-6">

        <!-- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É -->
        <h2 class="text-xl font-bold mb-2">üë§ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É</h2>
        <p class="text-sm text-gray-500 mb-2">
            –ú–æ–∂–Ω–∞ –≤–∫–∞–∑–∞—Ç–∏ <span class="font-semibold">Telegram User ID</span> –∞–±–æ <span class="font-semibold">@username</span>.
        </p>
        <input id="userId" type="text" placeholder="User ID –∞–±–æ @username" 
            class="w-full border px-3 py-2 rounded mb-3">
        <textarea id="userMsg" rows="4" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." 
            class="w-full border px-3 py-2 rounded mb-3"></textarea>
        <button onclick="sendToUser()" 
            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
            –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
        </button>

        <hr class="my-6">

        <!-- –°–ª—É–∂–±–æ–≤—ñ –¥—ñ—ó -->
        <h2 class="text-xl font-bold mb-4">‚öô –°–ª—É–∂–±–æ–≤—ñ –¥—ñ—ó</h2>

        <div class="flex flex-col gap-3">
            <button onclick="forceUpdate('auto')"
                class="w-full bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                üìä –§–æ—Ä—Å-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ç—É—Ä–Ω—ñ—Ä—ñ–≤
            </button>

            <button onclick="forceUpdate('extra')"
                class="w-full bg-teal-600 text-white px-6 py-2 rounded hover:bg-teal-700">
                üèÜ –§–æ—Ä—Å-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ç—É—Ä–Ω—ñ—Ä—ñ–≤
            </button>

            <button onclick="sendReminderToSelf()"
                class="w-full bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                ‚è∞ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –º–µ–Ω—ñ
            </button>

            <button onclick="resetRating()"
                class="w-full bg-orange-600 text-white px-6 py-2 rounded hover:bg-orange-700">
                ‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ —É—Å—ñ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º
            </button>
        </div>

        <div id="result" class="mt-6 p-4 rounded hidden"></div>
    </div>

    <script>
        async function sendBroadcast() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            const message = document.getElementById('broadcastMsg').value.trim();

            if (!message) {
                showResult('–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!', 'error');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/api/admin/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ –ù–∞–¥—ñ—Å–ª–∞–Ω–æ ${data.sent} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º!`, 'success');
                    document.getElementById('broadcastMsg').value = '';
                } else {
                    showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        async function sendToUser() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            const target = document.getElementById('userId').value.trim();
            const message = document.getElementById('userMsg').value.trim();

            if (!target || !message) {
                showResult('–í–≤–µ–¥—ñ—Ç—å User ID –∞–±–æ @username —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!', 'error');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/api/admin/send-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    },
                    body: JSON.stringify({ target, message })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ –ù–∞–¥—ñ—Å–ª–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É ${target}!`, 'success');
                    document.getElementById('userMsg').value = '';
                } else {
                    showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        // üîÑ –§–æ—Ä—Å-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤
        async function forceUpdate(mode) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();

            try {
                const response = await fetch(`${apiUrl}/api/force-update?mode=${mode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResult(`‚úÖ –§–æ—Ä—Å-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è (${mode}) –≤–∏–∫–æ–Ω–∞–Ω–æ`, 'success');
                } else {
                    showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || 'unknown'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        // ‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —Å–æ–±—ñ
        async function sendReminderToSelf() {
          const apiUrl = document.getElementById('apiUrl').value.trim();
          const adminKey = document.getElementById('adminKey').value.trim();
          const userField = document.getElementById('userId').value.trim(); // –º–æ–∂–Ω–æ id –∏–ª–∏ @username

          try {
            const params = userField
              ? `?userId=${encodeURIComponent(userField)}`
              : '';
            const response = await fetch(`${apiUrl}/api/notify-upcoming${params}`, {
              method: 'POST',
              headers: {
                'X-Admin-Key': adminKey
              }
            });
        
            const data = await response.json();
        
            if (response.ok && data.ok) {
              showResult('‚úÖ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ –≤–∞–º', 'success');
            } else {
              showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.message || data.error || 'Unknown error'}`, 'error');
            }
          } catch (error) {
            showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
          }
        }


        // ‚ôªÔ∏è –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ —É—Å—ñ–º
        async function resetRating() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();

            if (!confirm('–¢–æ—á–Ω–æ —Å–∫–∏–Ω—É—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ —É—Å—ñ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º?')) {
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/api/reset-rating`, {
                    method: 'POST',
                    headers: {
                        'X-Admin-Key': adminKey
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResult(`‚úÖ –†–µ–π—Ç–∏–Ω–≥ —Å–∫–∏–Ω—É—Ç–æ ${data.users} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º`, 'success');
                } else {
                    showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        function showResult(msg, type) {
            const result = document.getElementById('result');
            result.textContent = msg;
            result.className =
                `mt-6 p-4 rounded ` +
                (type === 'success'
                    ? 'bg-green-100 text-green-800'
                    : 'bg-red-100 text-red-800');
            result.classList.remove('hidden');
        }
    </script>
</body>
</html>
