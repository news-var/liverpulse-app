<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–õ—ñ–≤–µ—Ä–ø—É–ª—å—Å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { overflow-x: hidden; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .loading { animation: pulse 1.5s ease-in-out infinite; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>

<script>
// ==========================================
// CONFIG
// ==========================================
const CONFIG = {
  API_URL: 'https://liverpulse-worker.liverpulse.workers.dev',
  USE_TELEGRAM: true,
  LOGO_BASE: 'https://your-domain-or-gh-pages-url/logos',
  BOT_USERNAME: 'liverpulse_bet_bot'
};

// ==========================================
// TELEGRAM
// ==========================================
const tg = window.Telegram?.WebApp;
if (tg && CONFIG.USE_TELEGRAM) {
  tg.ready();
  tg.expand();
  tg.enableClosingConfirmation();
  tg.setHeaderColor('#dc2626');
  tg.setBackgroundColor('#f9fafb');
}

// ==========================================
// STATE
// ==========================================
const state = {
  user: null,
  matches: [],
  myBets: [],
  leaderboard: [],
  currentPage: 'matches',
  loading: true,
  selectedMatch: null,
  betSlip: { matchId: 0, type: '', selection: '', odds: 0, stake: 50 },
  expanded: { totals: {}, handicaps: {}, correctScore: {} },

  referral: {
    loading: false,
    link: null,
    code: null,
    max: 10,
    used: 0,
    remaining: 10,
    rows: []
  }
};

// ==========================================
// API
// ==========================================
async function apiRequest(endpoint, options = {}) {
  try {
    const headers = { 'Content-Type': 'application/json', ...options.headers };
    if (tg && CONFIG.USE_TELEGRAM) headers['Authorization'] = `Bearer ${tg.initData}`;

    const response = await fetch(`${CONFIG.API_URL}${endpoint}`, { ...options, headers });

    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error || '–ü–æ–º–∏–ª–∫–∞');
    }
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    showError(error.message);
    throw error;
  }
}

async function loadUser(){ state.user = await apiRequest('/api/user'); }
async function loadMatches(){ state.matches = await apiRequest('/api/matches'); }
async function loadMyBets(){ state.myBets = await apiRequest('/api/my-bets'); }
async function loadLeaderboard(){ state.leaderboard = await apiRequest('/api/leaderboard'); }

async function loadReferralSummary() {
  state.referral.loading = true; render();
  try {
    const res = await apiRequest('/api/referral');
    state.referral.link = res.link;
    state.referral.code = res.code;
    state.referral.max = res.max || 10;
    state.referral.used = res.used || 0;
    state.referral.remaining = res.remaining ?? Math.max(0, state.referral.max - state.referral.used);
    state.referral.rows = Array.isArray(res.rows) ? res.rows : [];
  } finally {
    state.referral.loading = false; render();
  }
}

async function getOrCreateReferralLink() {
  state.referral.loading = true; render();
  try {
    const res = await apiRequest('/api/referral/link', { method: 'POST' });
    state.referral.link = res.link;
    state.referral.code = res.code;
    state.referral.max = res.max || state.referral.max || 10;
    showSuccess('–í–∞—à–∞ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫–∞ –≥–æ—Ç–æ–≤–∞ ‚úÖ');
    await loadReferralSummary();
  } finally {
    state.referral.loading = false; render();
  }
}

async function verifyReferralReward() {
  state.referral.loading = true; render();
  try {
    const res = await apiRequest('/api/referral/verify', { method: 'POST' });
    if (res.ok && res.rewarded) {
      showSuccess(`–ë–æ–Ω—É—Å –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ! +${res.pointsAdded || 50} –±–∞–ª—ñ–≤ ‚úÖ`);
    } else {
      const reason = res.reason || res.error || 'no_reward';
      if (reason === 'not_member') showError('–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–µ —Ä–∞–∑.');
      else if (reason === 'already_rewarded') showSuccess('–ë–æ–Ω—É—Å —É–∂–µ –±—É–≤ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∏–π ‚úÖ');
      else if (reason === 'no_referral') showError('–£ –≤–∞—Å –Ω–µ–º–∞—î —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.');
      else showError('–ü–æ–∫–∏ —â–æ –±–æ–Ω—É—Å –Ω–µ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ.');
    }
    await loadUser();
  } finally {
    state.referral.loading = false; render();
  }
}

async function placeBet() {
  const { matchId, type, selection, odds, stake } = state.betSlip;

  if (stake < 10) return showError('–ú—ñ–Ω—ñ–º—É–º 10 –±–∞–ª—ñ–≤');
  if (stake > state.user.points) return showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–∞–ª—ñ–≤!');

  try {
    const result = await apiRequest('/api/bet', {
      method: 'POST',
      body: JSON.stringify({ matchId, betType: type, selection, odds, stake })
    });

    state.user.points = result.newBalance;
    state.selectedMatch = null;
    state.currentPage = 'bets';

    await loadMyBets();
    showSuccess('–°—Ç–∞–≤–∫—É –ø—Ä–∏–π–Ω—è—Ç–æ! ‚úÖ');
    if (tg) tg.HapticFeedback.notificationOccurred('success');

    render();
  } catch (error) {
    console.error('Bet error:', error);
  }
}

// ==========================================
// UTILS
// ==========================================
function showError(msg) {
  try {
    if (tg && typeof tg.showAlert === 'function') {
      tg.showAlert(msg);
      tg.HapticFeedback?.notificationOccurred?.('error');
    } else alert(msg);
  } catch { alert(msg); }
}

function showSuccess(msg) {
  try {
    if (tg && typeof tg.showAlert === 'function') {
      tg.showAlert(msg);
      tg.HapticFeedback?.notificationOccurred?.('success');
    } else alert(msg);
  } catch { alert(msg); }
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleString('uk-UA', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function teamSlug(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
}
function getTeamLogo(name) {
  if (!CONFIG.LOGO_BASE || !name) return null;
  return `${CONFIG.LOGO_BASE}/${teamSlug(name)}.png`;
}

function computeDoubleChanceOdds(match) {
  const oh = Number(match.odds_home || 0);
  const od = Number(match.odds_draw || 0);
  const oa = Number(match.odds_away || 0);
  if (!oh || !od || !oa) return null;

  const pHomeRaw = 1 / oh, pDrawRaw = 1 / od, pAwayRaw = 1 / oa;
  const overround = pHomeRaw + pDrawRaw + pAwayRaw;

  const pHome = pHomeRaw / overround, pDraw = pDrawRaw / overround, pAway = pAwayRaw / overround;
  const margin = 1.05;
  const makeOdd = (p) => p > 0 ? Number((1 / (p * margin)).toFixed(2)) : null;

  return { '1X': makeOdd(pHome + pDraw), '12': makeOdd(pHome + pAway), 'X2': makeOdd(pDraw + pAway) };
}

async function copyText(text) {
  try {
    if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
    else {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
      document.body.appendChild(ta); ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
    }
    showSuccess('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úÖ');
    tg?.HapticFeedback?.impactOccurred?.('light');
  } catch {
    showError('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏');
  }
}

function shareLink(link) {
  const text = '–ó–∞—Ö–æ–¥—å —É –õ—ñ–≤–µ—Ä–ø—É–ª—å—Å —Ç–∞ —Ä–æ–±–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏ –∑—ñ –º–Ω–æ—é!';
  const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
  try {
    if (tg?.openTelegramLink) tg.openTelegramLink(shareUrl);
    else window.open(shareUrl, '_blank');
  } catch { window.open(shareUrl, '_blank'); }
}

// ==========================================
// RENDER
// ==========================================
function renderHeader() {
  return `
    <div class="bg-gradient-to-r from-red-600 to-red-700 text-white p-4 sticky top-0 z-10 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold">‚öΩ –õ—ñ–≤–µ—Ä–ø—É–ª—å—Å</h1>
          <p class="text-sm opacity-90">@${state.user?.telegram_username || '–ì—Ä–∞–≤–µ—Ü—å'}</p>
        </div>
        <div class="text-right">
          <p class="text-sm opacity-90">–ë–∞–ª–∞–Ω—Å</p>
          <p class="text-2xl font-bold">${state.user?.points || 0}</p>
        </div>
      </div>
    </div>
  `;
}

function renderMatches() {
  if (state.matches.length === 0) {
    return `
      <div class="bg-white rounded-lg p-8 text-center text-gray-500">
        <p class="text-4xl mb-2">üìÖ</p>
        <p>–ü–æ–∫–∏ –Ω–µ–º–∞—î –º–∞—Ç—á—ñ–≤</p>
        <p class="text-sm">–ú–∞—Ç—á—ñ –∑'—è–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</p>
      </div>
    `;
  }

  return state.matches.map(m => {
    const homeLogo = getTeamLogo(m.home_team);
    const awayLogo = getTeamLogo(m.away_team);

    if (m.status === 'finished') {
      return `
        <div class="bg-red-50 border border-red-200 rounded-lg shadow-md p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2 flex-1 justify-center">
              ${homeLogo ? `<img src="${homeLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
              <p class="font-bold text-lg">${m.home_team}</p>
            </div>
            <div class="px-4 text-2xl font-bold text-red-700">
              ${m.home_score ?? '-'} : ${m.away_score ?? '-'}
            </div>
            <div class="flex items-center gap-2 flex-1 justify-center">
              ${awayLogo ? `<img src="${awayLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
              <p class="font-bold text-lg">${m.away_team}</p>
            </div>
          </div>
          <div class="text-center text-sm text-gray-500">üìÖ ${formatDate(m.match_date)}</div>
          ${m.competition ? `<div class="text-center text-xs text-gray-400 mt-1">üèÜ ${m.competition}</div>` : ''}
          <div class="text-center text-sm font-semibold text-red-700 mt-1">–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
        </div>
      `;
    }

    let statusBlock = '';
    if (m.status === 'locked') statusBlock = `<div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-center text-yellow-700 text-sm mt-2">üîí –°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä–∏—Ç—ñ (–º–∞—Ç—á —Å–∫–æ—Ä–æ –ø–æ—á–Ω–µ—Ç—å—Å—è)</div>`;
    if (m.status === 'live') statusBlock = `<div class="bg-green-50 border border-green-200 rounded p-2 text-center text-green-700 text-sm mt-2">üü¢ –ú–∞—Ç—á —Ç—Ä–∏–≤–∞—î, —Å—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä–∏—Ç—ñ</div>`;

    const canBet = m.status === 'upcoming';
    const dc = canBet ? computeDoubleChanceOdds(m) : null;
    const doubleChanceRow = (canBet && dc) ? `
      <div class="grid grid-cols-3 gap-2 mt-2">
        <button onclick="openBet(${m.id}, '1X2', '1X', ${dc['1X']})" class="bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded p-2 active:scale-95">
          <p class="text-xs text-gray-600">1X</p><p class="font-bold text-slate-700">${dc['1X']}</p>
        </button>
        <button onclick="openBet(${m.id}, '1X2', '12', ${dc['12']})" class="bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded p-2 active:scale-95">
          <p class="text-xs text-gray-600">12</p><p class="font-bold text-slate-700">${dc['12']}</p>
        </button>
        <button onclick="openBet(${m.id}, '1X2', 'X2', ${dc['X2']})" class="bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded p-2 active:scale-95">
          <p class="text-xs text-gray-600">X2</p><p class="font-bold text-slate-700">${dc['X2']}</p>
        </button>
      </div>
    ` : '';

    return `
      <div class="bg-white rounded-lg shadow-md p-4 border border-gray-200">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2 flex-1 justify-center">
            ${homeLogo ? `<img src="${homeLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
            <p class="font-bold text-lg">${m.home_team}</p>
          </div>
          <div class="px-4"><p class="text-gray-400">VS</p></div>
          <div class="flex items-center gap-2 flex-1 justify-center">
            ${awayLogo ? `<img src="${awayLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
            <p class="font-bold text-lg">${m.away_team}</p>
          </div>
        </div>

        <div class="text-center text-sm text-gray-500">üìÖ ${formatDate(m.match_date)}</div>
        ${m.competition ? `<div class="text-center text-xs text-gray-400 mt-1 mb-2">üèÜ ${m.competition}</div>` : `<div class="mt-2"></div>`}

        ${canBet ? `
          <div class="grid grid-cols-3 gap-2">
            <button onclick="openBet(${m.id}, '1X2', '–ü1', ${m.odds_home})" class="bg-green-50 hover:bg-green-100 border border-green-200 rounded p-2 active:scale-95">
              <p class="text-xs text-gray-600">–ü1</p><p class="font-bold text-green-700">${m.odds_home}</p>
            </button>
            <button onclick="openBet(${m.id}, '1X2', 'X', ${m.odds_draw})" class="bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded p-2 active:scale-95">
              <p class="text-xs text-gray-600">X</p><p class="font-bold text-blue-700">${m.odds_draw}</p>
            </button>
            <button onclick="openBet(${m.id}, '1X2', '–ü2', ${m.odds_away})" class="bg-red-50 hover:bg-red-100 border border-red-200 rounded p-2 active:scale-95">
              <p class="text-xs text-gray-600">–ü2</p><p class="font-bold text-red-700">${m.odds_away}</p>
            </button>
          </div>
          ${doubleChanceRow}
        ` : statusBlock}
      </div>
    `;
  }).join('');
}

function renderBets() {
  if (state.myBets.length === 0) {
    return `
      <div class="bg-white rounded-lg p-8 text-center text-gray-500">
        <p class="text-4xl mb-2">üí∞</p>
        <p>–£ –≤–∞—Å –Ω–µ–º–∞—î —Å—Ç–∞–≤–æ–∫</p>
        <p class="text-sm">–ó—Ä–æ–±—ñ—Ç—å –ø–µ—Ä—à—É!</p>
      </div>
    `;
  }

  return state.myBets.map(b => `
    <div class="bg-white rounded-lg shadow p-4 border border-gray-200">
      <p class="font-bold">${b.match?.home_team || '–ú–∞—Ç—á'} ‚Äì ${b.match?.away_team || ''}</p>
      <p class="text-sm text-gray-600 mt-1">${b.bet_type} - ${b.selection}</p>
      <div class="grid grid-cols-3 gap-2 text-sm mt-3">
        <div><p class="text-gray-500">–°—Ç–∞–≤–∫–∞</p><p class="font-bold">${b.stake}</p></div>
        <div><p class="text-gray-500">–ö–æ–µ—Ñ.</p><p class="font-bold">${b.odds}</p></div>
        <div><p class="text-gray-500">–°—Ç–∞—Ç—É—Å</p><p class="font-bold">${b.status}</p></div>
      </div>
      <p class="text-xs text-gray-400 mt-2">${formatDate(b.created_at)}</p>
    </div>
  `).join('');
}

function renderLeaderboard() {
  return state.leaderboard.map(p => `
    <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
      <div>
        <p class="font-bold">${p.username}</p>
        <p class="text-sm text-gray-600">–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å: ${p.winRate}%</p>
      </div>
      <div class="text-right">
        <p class="font-bold text-xl text-red-600">${p.points}</p>
      </div>
    </div>
  `).join('');
}

function renderReferralPage() {
  const loading = state.referral.loading;

  const hasLink = !!state.referral.link;
  const needsVerify = !!(state.user?.referrer_id && state.user?.referral_rewarded === false);

  return `
    <div class="space-y-4">

      <div class="bg-white rounded-lg shadow p-4 border border-gray-200">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-lg font-bold">üéÅ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è</p>
            <p class="text-sm text-gray-600 mt-1">
              –û–¥–Ω–∞ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫–∞ –Ω–∞ –∞–∫–∞—É–Ω—Ç. –õ—ñ–º—ñ—Ç: <span class="font-bold">${state.referral.max}</span> –¥—Ä—É–∑—ñ–≤.
            </p>
          </div>
          <button onclick="refRefresh()" class="bg-gray-100 hover:bg-gray-200 rounded-lg px-3 py-2 text-sm active:scale-95">
            üîÑ –û–Ω–æ–≤–∏—Ç–∏
          </button>
        </div>

        <div class="mt-4">
          <p class="text-xs text-gray-500 mb-1">–í–∞—à–∞ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫–∞</p>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
            <div class="text-[12px] font-mono break-all ${hasLink ? 'text-gray-900' : 'text-gray-400'}">
              ${hasLink ? state.referral.link : '–©–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ'}
            </div>
            <div class="grid grid-cols-3 gap-2 mt-3">
              <button onclick="refCreateLink()" class="col-span-1 bg-red-600 hover:bg-red-700 text-white rounded-md py-2 text-sm font-semibold active:scale-95">
                ${hasLink ? '–ü–æ–∫–∞–∑–∞—Ç–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏'}
              </button>
              <button ${hasLink ? '' : 'disabled'} onclick="refCopy()" class="col-span-1 bg-white border border-gray-200 rounded-md py-2 text-sm active:scale-95 ${hasLink ? '' : 'opacity-40'}">
                üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏
              </button>
              <button ${hasLink ? '' : 'disabled'} onclick="refShare()" class="col-span-1 bg-white border border-gray-200 rounded-md py-2 text-sm active:scale-95 ${hasLink ? '' : 'opacity-40'}">
                üöÄ –®–µ—Ä
              </button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2 mt-4">
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ</p>
            <p class="text-xl font-bold">${state.referral.used}</p>
          </div>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">–ó–∞–ª–∏—à–∏–ª–æ—Å—å</p>
            <p class="text-xl font-bold">${state.referral.remaining}</p>
          </div>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">–ë–æ–Ω—É—Å</p>
            <p class="text-xl font-bold">+50</p>
          </div>
        </div>

        ${needsVerify ? `
          <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
            <p class="text-sm font-semibold text-yellow-800">–£ –≤–∞—Å —î –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</p>
            <p class="text-xs text-yellow-700 mt-1">–ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –Ω–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–æ–Ω—É—Å –∑–∞–ø—Ä–æ—à—É–≤–∞—á—É.</p>
            <button onclick="refVerify()" class="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white rounded-md py-2 text-sm font-semibold active:scale-95">
              ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É
            </button>
          </div>
        ` : ''}
      </div>

      <div class="bg-white rounded-lg shadow p-4 border border-gray-200">
        <p class="font-bold mb-2">–°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—à–µ–Ω–∏—Ö</p>

        ${loading ? `
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-sm text-gray-600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        ` : ''}

        ${(!loading && state.referral.rows.length === 0) ? `
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-sm text-gray-600">
            –ü–æ–∫–∏ —â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –ø–æ –≤–∞—à—ñ–π –ª—ñ–Ω—Ü—ñ.
          </div>
        ` : ''}

        <div class="space-y-2">
          ${state.referral.rows.map(r => {
            const badge = r.rewarded
              ? `<span class="text-[11px] px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">–ë–æ–Ω—É—Å –≤–∏–¥–∞–Ω–æ</span>`
              : `<span class="text-[11px] px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">–û—á—ñ–∫—É—î–º–æ –ø—ñ–¥–ø–∏—Å–∫—É</span>`;
            return `
              <div class="border border-gray-200 rounded-lg p-3">
                <div class="flex items-center justify-between gap-2">
                  <div class="min-w-0">
                    <p class="text-xs text-gray-500">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</p>
                    <p class="font-semibold truncate">@${r.invited_username}</p>
                    <p class="text-[11px] text-gray-400 mt-1">–ó–∞–π—à–æ–≤: ${formatDate(r.claimed_at)}</p>
                  </div>
                  <div>${badge}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>

    </div>
  `;
}

function renderBetModal() {
  if (!state.selectedMatch) return '';
  const match = state.matches.find(m => m.id === state.selectedMatch);
  if (!match) return '';

  return `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModal(event)">
      <div class="bg-white rounded-lg p-6 max-w-md w-full" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">–ó—Ä–æ–±–∏—Ç–∏ —Å—Ç–∞–≤–∫—É</h3>
        <div class="bg-gray-50 rounded p-3 mb-4">
          <p class="text-sm text-gray-600">–ú–∞—Ç—á</p>
          <p class="font-bold">${match.home_team} vs ${match.away_team}</p>
          <p class="text-sm text-gray-600 mt-2">–í–∏–±—ñ—Ä</p>
          <p class="font-bold">${state.betSlip.selection}</p>
          <p class="text-sm text-gray-600 mt-2">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç</p>
          <p class="font-bold text-lg text-green-600">${state.betSlip.odds}</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">–°—É–º–∞ —Å—Ç–∞–≤–∫–∏ (–±–∞–ª–∏)</label>
          <input id="stake" type="number" min="10" max="${state.user.points}" value="${state.betSlip.stake}"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 text-lg"
            oninput="updateStake(this.value)">
        </div>

        <div class="bg-blue-50 rounded p-3 mb-4">
          <p class="text-sm text-gray-600">–ú–æ–∂–ª–∏–≤–∏–π –≤–∏–≥—Ä–∞—à</p>
          <p class="text-2xl font-bold text-blue-600" id="win">${(state.betSlip.stake * state.betSlip.odds).toFixed(0)}</p>
        </div>

        <div class="flex gap-3">
          <button onclick="state.selectedMatch = null; render()" class="flex-1 bg-gray-200 hover:bg-gray-300 font-semibold py-3 rounded-lg active:scale-95">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button onclick="placeBet()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg active:scale-95">–ü–æ—Å—Ç–∞–≤–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  `;
}

function renderNav() {
  const pages = [
    { id: 'matches', icon: 'üìä', label: '–ú–∞—Ç—á—ñ' },
    { id: 'bets', icon: 'üí∞', label: '–°—Ç–∞–≤–∫–∏' },
    { id: 'leaderboard', icon: 'üèÜ', label: '–†–µ–π—Ç–∏–Ω–≥' },
    { id: 'referral', icon: 'üéÅ', label: '–ó–∞–ø—Ä–æ—à' }
  ];

  return `
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t px-2 py-2 safe-bottom z-40">
      <div class="grid grid-cols-4 gap-2">
        ${pages.map(p => `
          <button onclick="changePage('${p.id}')"
            class="flex flex-col items-center py-2 rounded-lg active:scale-95 ${
              state.currentPage === p.id ? 'bg-red-50 text-red-600' : 'text-gray-600'
            }">
            <span class="text-2xl mb-1">${p.icon}</span>
            <span class="text-xs font-medium">${p.label}</span>
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function render() {
  const app = document.getElementById('app');

  if (state.loading) {
    app.innerHTML = `
      <div class="flex items-center justify-center min-h-screen">
        <div class="text-center">
          <div class="loading text-6xl mb-4">‚öΩ</div>
          <p class="text-gray-600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
      </div>
    `;
    return;
  }

  let content = '';
  if (state.currentPage === 'matches') {
    content = `
      <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-lg p-4 text-white mb-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-90">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
            <p class="text-3xl font-bold">${state.user.points}</p>
          </div>
          <div class="text-5xl">üèÜ</div>
        </div>
      </div>
      <h2 class="text-xl font-bold mb-4">‚è∞ –ú–∞–π–±—É—Ç–Ω—ñ –º–∞—Ç—á—ñ</h2>
      <div class="space-y-4">${renderMatches()}</div>
    `;
  } else if (state.currentPage === 'bets') {
    content = `<h2 class="text-xl font-bold mb-4">üìã –ú–æ—ó —Å—Ç–∞–≤–∫–∏</h2><div class="space-y-4">${renderBets()}</div>`;
  } else if (state.currentPage === 'leaderboard') {
    content = `<h2 class="text-xl font-bold mb-4">üëë –†–µ–π—Ç–∏–Ω–≥</h2><div class="space-y-4">${renderLeaderboard()}</div>`;
  } else if (state.currentPage === 'referral') {
    content = renderReferralPage();
  }

  app.innerHTML = `
    ${renderHeader()}
    <div class="p-4 pb-24">${content}</div>
    ${renderNav()}
    ${renderBetModal()}
  `;
}

// ==========================================
// GLOBALS
// ==========================================
window.changePage = async (page) => {
  state.currentPage = page;
  tg?.HapticFeedback?.impactOccurred?.('light');

  if (page === 'bets') await loadMyBets();
  if (page === 'leaderboard') await loadLeaderboard();
  if (page === 'referral') await loadReferralSummary();

  render();
};

window.openBet = (matchId, type, selection, odds) => {
  state.selectedMatch = matchId;
  state.betSlip = { matchId, type, selection, odds, stake: 50 };
  tg?.HapticFeedback?.impactOccurred?.('medium');
  render();
};

window.closeModal = (e) => {
  if (e.target === e.currentTarget) { state.selectedMatch = null; render(); }
};

window.updateStake = (val) => {
  state.betSlip.stake = parseInt(val) || 0;
  const win = (state.betSlip.stake * state.betSlip.odds).toFixed(0);
  document.getElementById('win').textContent = win;
};

// Referral actions
window.refRefresh = async () => await loadReferralSummary();
window.refCreateLink = async () => await getOrCreateReferralLink();
window.refCopy = async () => state.referral.link && copyText(state.referral.link);
window.refShare = () => state.referral.link && shareLink(state.referral.link);
window.refVerify = async () => await verifyReferralReward();

// ==========================================
// INIT
// ==========================================
async function init() {
  try {
    state.loading = true; render();

    await loadUser();
    await loadMatches();

    state.loading = false; render();
  } catch (error) {
    console.error('Init error:', error);
    state.loading = false;
    document.getElementById('app').innerHTML = `
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="text-center">
          <p class="text-6xl mb-4">‚ùå</p>
          <p class="text-xl font-bold mb-2">–ü–æ–º–∏–ª–∫–∞</p>
          <p class="text-gray-600 mb-4">${error.message}</p>
          <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg">
            –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
          </button>
        </div>
      </div>
    `;
  }
}
init();
</script>
</body>
</html>
