<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ—ñ–≤–µ—Ä–ø—É–ª—å—Å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* ===== FAB + Bottom sheet ===== */
        .fab {
            position: fixed;
            right: 16px;
            bottom: calc(env(safe-area-inset-bottom) + 84px); /* –Ω–∞–¥ –Ω–∏–∂–Ω—ñ–º –º–µ–Ω—é */
            z-index: 60;
        }
        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 70;
        }
        .sheet-panel {
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
        }
    </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>

<script>
// ==========================================
// –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
// ==========================================
const CONFIG = {
    API_URL: 'https://liverpulse-worker.liverpulse.workers.dev',
    USE_TELEGRAM: true,
    LOGO_BASE: 'https://your-domain-or-gh-pages-url/logos'
};

// ==========================================
// TELEGRAM
// ==========================================
const tg = window.Telegram?.WebApp;
if (tg && CONFIG.USE_TELEGRAM) {
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();
    tg.setHeaderColor('#dc2626');
    tg.setBackgroundColor('#f9fafb');
}

// ==========================================
// –°–¢–ê–ù
// ==========================================
const state = {
    user: null,
    matches: [],
    myBets: [],
    leaderboard: [],
    currentPage: 'matches',
    loading: true,
    selectedMatch: null,
    betSlip: { matchId: 0, type: '', selection: '', odds: 0, stake: 50 },
    expanded: {
        totals: {},
        handicaps: {},
        correctScore: {}
    },

    // ‚úÖ Referral UI state
    referral: {
        open: false,
        tab: 'invite', // invite | mycodes
        loading: false,
        max: 10,
        codes: [],
        lastCode: null,
        lastLink: null
    }
};

// ==========================================
// API
// ==========================================
async function apiRequest(endpoint, options = {}) {
    try {
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (tg && CONFIG.USE_TELEGRAM) {
            headers['Authorization'] = `Bearer ${tg.initData}`;
        }

        const response = await fetch(`${CONFIG.API_URL}${endpoint}`, {
            ...options,
            headers
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '–ü–æ–º–∏–ª–∫–∞');
        }

        return await response.json();
    } catch (error) {
        console.error('API Error:', error);
        showError(error.message);
        throw error;
    }
}

async function loadUser() {
    state.user = await apiRequest('/api/user');
}

async function loadMatches() {
    state.matches = await apiRequest('/api/matches');
}

async function loadMyBets() {
    state.myBets = await apiRequest('/api/my-bets');
}

async function loadLeaderboard() {
    state.leaderboard = await apiRequest('/api/leaderboard');
}

// ‚úÖ Referral API
async function loadReferralCodes() {
    const res = await apiRequest('/api/referral/codes');
    state.referral.max = res.max || 10;
    state.referral.codes = Array.isArray(res.rows) ? res.rows : [];
}

async function createReferralCode() {
    state.referral.loading = true;
    render();
    try {
        const res = await apiRequest('/api/referral/create', { method: 'POST' });

        if (res.ok === false) {
            showError(res.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–¥');
            return;
        }

        if (res.limitReached) {
            showError('–õ—ñ–º—ñ—Ç –∫–æ–¥—ñ–≤ –¥–æ—Å—è–≥–Ω—É—Ç–æ (10/10). –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —ñ—Å–Ω—É—é—á—ñ.');
        } else if (res.link) {
            state.referral.lastCode = res.code;
            state.referral.lastLink = res.link;
            showSuccess('–Ü–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ ‚úÖ');
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        await loadReferralCodes();
    } finally {
        state.referral.loading = false;
        render();
    }
}

async function verifyReferralReward() {
    state.referral.loading = true;
    render();
    try {
        const res = await apiRequest('/api/referral/verify', { method: 'POST' });

        if (res.ok && res.rewarded) {
            showSuccess(`–ë–æ–Ω—É—Å –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ! +${res.pointsAdded} –±–∞–ª—ñ–≤ ‚úÖ`);
        } else {
            const reason = res.reason || res.error || 'no_reward';
            if (reason === 'not_member') showError('–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–µ —Ä–∞–∑.');
            else if (reason === 'already_rewarded') showSuccess('–ë–æ–Ω—É—Å —É–∂–µ –±—É–≤ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–∏–π ‚úÖ');
            else if (reason === 'no_referral') showError('–£ –≤–∞—Å –Ω–µ–º–∞—î —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.');
            else showError('–ü–æ–∫–∏ —â–æ –±–æ–Ω—É—Å –Ω–µ –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ.');
        }

        // –æ–Ω–æ–≤–∏–º–æ —é–∑–µ—Ä–∞, —â–æ–± –ø—ñ–¥—Ç—è–≥–Ω—É–≤ referral_rewarded
        await loadUser();
    } finally {
        state.referral.loading = false;
        render();
    }
}

async function placeBet() {
    const { matchId, type, selection, odds, stake } = state.betSlip;

    if (stake < 10) {
        showError('–ú—ñ–Ω—ñ–º—É–º 10 –±–∞–ª—ñ–≤');
        return;
    }

    if (stake > state.user.points) {
        showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–∞–ª—ñ–≤!');
        return;
    }

    try {
        const result = await apiRequest('/api/bet', {
            method: 'POST',
            body: JSON.stringify({ matchId, betType: type, selection, odds, stake })
        });

        state.user.points = result.newBalance;
        state.selectedMatch = null;
        state.currentPage = 'bets';

        await loadMyBets();
        showSuccess('–°—Ç–∞–≤–∫—É –ø—Ä–∏–π–Ω—è—Ç–æ! ‚úÖ');
        if (tg) tg.HapticFeedback.notificationOccurred('success');

        render();
    } catch (error) {
        console.error('Bet error:', error);
    }
}

// ==========================================
// –£–¢–ò–õ–Ü–¢–ò
// ==========================================
function showError(msg) {
    try {
        if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert(msg);
            if (tg.HapticFeedback && typeof tg.HapticFeedback.notificationOccurred === 'function') {
                tg.HapticFeedback.notificationOccurred('error');
            }
        } else {
            alert(msg);
        }
    } catch (e) {
        console.error('showError failed:', e);
        alert(msg);
    }
}

function showSuccess(msg) {
    try {
        if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert(msg);
            if (tg.HapticFeedback && typeof tg.HapticFeedback.notificationOccurred === 'function') {
                tg.HapticFeedback.notificationOccurred('success');
            }
        } else {
            alert(msg);
        }
    } catch (e) {
        console.error('showSuccess failed:', e);
        alert(msg);
    }
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('uk-UA', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –õ–æ–≥–æ—Ç–∏–ø—ã –∫–æ–º–∞–Ω–¥
function teamSlug(name) {
    return name
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
}

function getTeamLogo(name) {
    if (!CONFIG.LOGO_BASE) return null;
    if (!name) return null;
    const slug = teamSlug(name);
    return `${CONFIG.LOGO_BASE}/${slug}.png`;
}

// –†–∞—Å—á—ë—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –Ω–∞ 1X / 12 / X2
function computeDoubleChanceOdds(match) {
    const oh = Number(match.odds_home || 0);
    const od = Number(match.odds_draw || 0);
    const oa = Number(match.odds_away || 0);

    if (!oh || !od || !oa) return null;

    const pHomeRaw = 1 / oh;
    const pDrawRaw = 1 / od;
    const pAwayRaw = 1 / oa;
    const overround = pHomeRaw + pDrawRaw + pAwayRaw;

    const pHome = pHomeRaw / overround;
    const pDraw = pDrawRaw / overround;
    const pAway = pAwayRaw / overround;

    const margin = 1.05;

    const makeOdd = (p) => p > 0 ? Number((1 / (p * margin)).toFixed(2)) : null;

    return {
        '1X': makeOdd(pHome + pDraw),
        '12': makeOdd(pHome + pAway),
        'X2': makeOdd(pDraw + pAway)
    };
}

// ‚úÖ Copy / Share helper
async function copyText(text) {
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
        } else {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }
        showSuccess('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úÖ');
        if (tg) tg.HapticFeedback.impactOccurred('light');
    } catch (e) {
        showError('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏');
    }
}

function shareLink(link) {
    const text = '–ó–∞—Ö–æ–¥—å —É –õ—ñ–≤–µ—Ä–ø—É–ª—å—Å —Ç–∞ —Ä–æ–±–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏ –∑—ñ –º–Ω–æ—é!';
    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;

    try {
        if (tg && typeof tg.openTelegramLink === 'function') {
            tg.openTelegramLink(shareUrl);
        } else {
            window.open(shareUrl, '_blank');
        }
    } catch (e) {
        window.open(shareUrl, '_blank');
    }
}

// ==========================================
// –†–ï–ù–î–ï–†–ò–ù–ì
// ==========================================
function renderHeader() {
    return `
        <div class="bg-gradient-to-r from-red-600 to-red-700 text-white p-4 sticky top-0 z-10 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold">‚öΩ –õ—ñ–≤–µ—Ä–ø—É–ª—å—Å</h1>
                    <p class="text-sm opacity-90">@${state.user?.telegram_username || '–ì—Ä–∞–≤–µ—Ü—å'}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm opacity-90">–ë–∞–ª–∞–Ω—Å</p>
                    <p class="text-2xl font-bold">${state.user?.points || 0}</p>
                </div>
            </div>
        </div>
    `;
}

function renderMatches() {
    if (state.matches.length === 0) {
        return `
            <div class="bg-white rounded-lg p-8 text-center text-gray-500">
                <p class="text-4xl mb-2">üìÖ</p>
                <p>–ü–æ–∫–∏ –Ω–µ–º–∞—î –º–∞—Ç—á—ñ–≤</p>
                <p class="text-sm">–ú–∞—Ç—á—ñ –∑'—è–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</p>
            </div>
        `;
    }

    return state.matches.map(m => {
        const homeLogo = getTeamLogo(m.home_team);
        const awayLogo = getTeamLogo(m.away_team);

        if (m.status === 'finished') {
            return `
                <div class="bg-red-50 border border-red-200 rounded-lg shadow-md p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2 flex-1 justify-center">
                            ${homeLogo ? `<img src="${homeLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
                            <p class="font-bold text-lg">${m.home_team}</p>
                        </div>
                        <div class="px-4 text-2xl font-bold text-red-700">
                            ${m.home_score ?? '-'} : ${m.away_score ?? '-'}
                        </div>
                        <div class="flex items-center gap-2 flex-1 justify-center">
                            ${awayLogo ? `<img src="${awayLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
                            <p class="font-bold text-lg">${m.away_team}</p>
                        </div>
                    </div>
                    <div class="text-center text-sm text-gray-500">
                        üìÖ ${formatDate(m.match_date)}
                    </div>
                    ${m.competition ? `
                        <div class="text-center text-xs text-gray-400 mt-1">
                            üèÜ ${m.competition}
                        </div>
                    ` : ''}
                    <div class="text-center text-sm font-semibold text-red-700 mt-1">
                        –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                    </div>
                </div>
            `;
        }

        let statusBlock = '';
        if (m.status === 'locked') {
            statusBlock = `
                <div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-center text-yellow-700 text-sm mt-2">
                    üîí –°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä–∏—Ç—ñ (–º–∞—Ç—á —Å–∫–æ—Ä–æ –ø–æ—á–Ω–µ—Ç—å—Å—è)
                </div>
            `;
        } else if (m.status === 'live') {
            statusBlock = `
                <div class="bg-green-50 border border-green-200 rounded p-2 text-center text-green-700 text-sm mt-2">
                    üü¢ –ú–∞—Ç—á —Ç—Ä–∏–≤–∞—î, —Å—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä–∏—Ç—ñ
                </div>
            `;
        }

        const canBet = m.status === 'upcoming';

        const dc = canBet ? computeDoubleChanceOdds(m) : null;
        const doubleChanceRow = (canBet && dc) ? `
            <div class="grid grid-cols-3 gap-2 mt-2">
                <button onclick="openBet(${m.id}, '1X2', '1X', ${dc['1X']})"
                    class="bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded p-2 active:scale-95">
                    <p class="text-xs text-gray-600">1X</p>
                    <p class="font-bold text-slate-700">${dc['1X']}</p>
                </button>
                <button onclick="openBet(${m.id}, '1X2', '12', ${dc['12']})"
                    class="bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded p-2 active:scale-95">
                    <p class="text-xs text-gray-600">12</p>
                    <p class="font-bold text-slate-700">${dc['12']}</p>
                </button>
                <button onclick="openBet(${m.id}, '1X2', 'X2', ${dc['X2']})"
                    class="bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded p-2 active:scale-95">
                    <p class="text-xs text-gray-600">X2</p>
                    <p class="font-bold text-slate-700">${dc['X2']}</p>
                </button>
            </div>
        ` : '';

        // ====== Totals ======
        let totalsBlock = '';
        const totalsLines = m.totals_lines || null;
        if (canBet && totalsLines && Object.keys(totalsLines).length > 0) {
            let rows = Object.entries(totalsLines)
                .map(([pt, line]) => {
                    const v = parseFloat(pt);
                    if (!Number.isFinite(v)) return null;
                    if (!Number.isInteger(v * 2)) return null;

                    const overRaw = line && line.over != null ? Number(line.over) : null;
                    const underRaw = line && line.under != null ? Number(line.under) : null;

                    const overOk = overRaw != null && overRaw >= 1.1;
                    const underOk = underRaw != null && underRaw >= 1.1;
                    if (!overOk && !underOk) return null;

                    return { pt, v, over: overOk ? overRaw : null, under: underOk ? underRaw : null };
                })
                .filter(row => row && (row.over || row.under))
                .sort((a, b) => a.v - b.v);

            if (rows.length > 0) {
                const isOpen = !!(state.expanded.totals[m.id]);

                totalsBlock = `
                    <div class="mt-3">
                        <button class="w-full flex justify-between items-center text-[13px] font-semibold px-3 py-2 bg-gray-100 rounded-md"
                            onclick="toggleTotals(${m.id})">
                            <span>–°—Ç–∞–≤–∫–∏ –Ω–∞ —Ç–æ—Ç–∞–ª</span>
                            <span>${isOpen ? '‚ñ≤' : '‚ñº'}</span>
                        </button>
                        ${isOpen ? `
                            <div class="mt-2 space-y-2">
                                ${rows.map(row => {
                                    const underDisabled = !row.under;
                                    const overDisabled = !row.over;
                                    return `
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <button ${underDisabled ? 'disabled' : ''}
                                                class="flex flex-col items-center justify-center ${
                                                    underDisabled ? 'bg-gray-50 border border-dashed border-gray-200 opacity-40 cursor-default'
                                                                  : 'bg-red-50 hover:bg-red-100 border border-red-200 active:scale-95'
                                                } rounded-md py-2 px-2"
                                                ${underDisabled ? '' : `onclick="openBet(${m.id}, '–¢–æ—Ç–∞–ª', '–ú ${row.pt}', ${row.under})"`}>
                                                <span class="text-[11px] text-gray-600">–¢–ú ${row.pt}</span>
                                                <span class="font-bold ${underDisabled ? 'text-gray-400' : 'text-red-700'}">${row.under ?? '-'}</span>
                                            </button>
                                            <button ${overDisabled ? 'disabled' : ''}
                                                class="flex flex-col items-center justify-center ${
                                                    overDisabled ? 'bg-gray-50 border border-dashed border-gray-200 opacity-40 cursor-default'
                                                                 : 'bg-green-50 hover:bg-green-100 border border-green-200 active:scale-95'
                                                } rounded-md py-2 px-2"
                                                ${overDisabled ? '' : `onclick="openBet(${m.id}, '–¢–æ—Ç–∞–ª', '–ë ${row.pt}', ${row.over})"`}>
                                                <span class="text-[11px] text-gray-600">–¢–ë ${row.pt}</span>
                                                <span class="font-bold ${overDisabled ? 'text-gray-400' : 'text-green-700'}">${row.over ?? '-'}</span>
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        // ====== Handicaps ======
        let handicapsBlock = '';
        const spreadLines = m.spread_lines || null;
        if (canBet && spreadLines && (spreadLines.home || spreadLines.away) &&
            (Object.keys(spreadLines.home || {}).length > 0 || Object.keys(spreadLines.away || {}).length > 0)
        ) {
            const homeMap = spreadLines.home || {};
            const awayMap = spreadLines.away || {};

            const rawKeys = new Set([...Object.keys(homeMap), ...Object.keys(awayMap)]);
            let absPoints = Array.from(rawKeys)
              .map(k => parseFloat(k))
              .filter(v => Number.isFinite(v))
              .map(v => Math.abs(v))
              .filter(v => Number.isInteger(v * 2) && Math.abs(v - 0.5) > 1e-9);

            absPoints = Array.from(new Set(absPoints)).sort((a, b) => a - b);

            const hasZero = homeMap['0'] != null || awayMap['0'] != null;
            const points = hasZero ? [0, ...absPoints.filter(p => p !== 0)] : absPoints;

            let rows = points.map(p => {
              const pos = String(p);
              const neg = String(-p);

              let lbl1, lbl2, sel1, sel2;
              let homeOddsRaw = null;
              let awayOddsRaw = null;

              if (p === 0) {
                homeOddsRaw = homeMap['0'] != null ? Number(homeMap['0']) : null;
                awayOddsRaw = awayMap['0'] != null ? Number(awayMap['0']) : null;
                lbl1 = '–§1 0'; lbl2 = '–§2 0';
                sel1 = '–ü1 (0)'; sel2 = '–ü2 (0)';
              } else {
                const homeMinus = homeMap[neg] != null ? Number(homeMap[neg]) : null;
                const awayPlus  = awayMap[pos] != null ? Number(awayMap[pos]) : null;

                const homePlus  = homeMap[pos] != null ? Number(homeMap[pos]) : null;
                const awayMinus = awayMap[neg] != null ? Number(awayMap[neg]) : null;

                const scoreA = (homeMinus != null) + (awayPlus != null);
                const scoreB = (homePlus != null) + (awayMinus != null);

                if ((homeMinus != null || awayPlus != null) && (scoreA >= scoreB)) {
                  homeOddsRaw = homeMinus; awayOddsRaw = awayPlus;
                  lbl1 = `–§1 -${p}`; lbl2 = `–§2 +${p}`;
                  sel1 = `–ü1 (-${p})`; sel2 = `–ü2 (+${p})`;
                } else if (homePlus != null || awayMinus != null) {
                  homeOddsRaw = homePlus; awayOddsRaw = awayMinus;
                  lbl1 = `–§1 +${p}`; lbl2 = `–§2 -${p}`;
                  sel1 = `–ü1 (+${p})`; sel2 = `–ü2 (-${p})`;
                } else return null;
              }

              const hOk = homeOddsRaw != null && homeOddsRaw >= 1.1;
              const aOk = awayOddsRaw != null && awayOddsRaw >= 1.1;
              if (!hOk && !aOk) return null;

              return { point: p, lbl1, lbl2, sel1, sel2, homeOdds: hOk ? homeOddsRaw : null, awayOdds: aOk ? awayOddsRaw : null };
            }).filter(Boolean);

            if (rows.length > 0) {
                const isOpen = !!(state.expanded.handicaps[m.id]);
                handicapsBlock = `
                    <div class="mt-3">
                        <button class="w-full flex justify-between items-center text-[13px] font-semibold px-3 py-2 bg-gray-100 rounded-md"
                            onclick="toggleHandicaps(${m.id})">
                            <span>–°—Ç–∞–≤–∫–∏ –∑ —Ñ–æ—Ä–æ—é</span>
                            <span>${isOpen ? '‚ñ≤' : '‚ñº'}</span>
                        </button>
                        ${isOpen ? `
                            <div class="mt-2 space-y-2">
                                ${rows.map(row => {
                                    const hDisabled = !row.homeOdds;
                                    const aDisabled = !row.awayOdds;
                                    return `
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <button ${hDisabled ? 'disabled' : ''}
                                                class="flex flex-col items-center justify-center ${
                                                    hDisabled ? 'bg-gray-50 border border-dashed border-gray-200 opacity-40 cursor-default'
                                                              : 'bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-md active:scale-95'
                                                } py-2 px-2"
                                                ${hDisabled ? '' : `onclick="openBet(${m.id}, '–§–æ—Ä–∞', '${row.sel1}', ${row.homeOdds})"`}>
                                                <span class="text-[11px] text-gray-600">${row.lbl1}</span>
                                                <span class="font-bold ${hDisabled ? 'text-gray-400' : 'text-indigo-700'}">${row.homeOdds ?? '-'}</span>
                                            </button>
                                            <button ${aDisabled ? 'disabled' : ''}
                                                class="flex flex-col items-center justify-center ${
                                                    aDisabled ? 'bg-gray-50 border border-dashed border-gray-200 opacity-40 cursor-default'
                                                              : 'bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-md active:scale-95'
                                                } py-2 px-2"
                                                ${aDisabled ? '' : `onclick="openBet(${m.id}, '–§–æ—Ä–∞', '${row.sel2}', ${row.awayOdds})"`}>
                                                <span class="text-[11px] text-gray-600">${row.lbl2}</span>
                                                <span class="font-bold ${aDisabled ? 'text-gray-400' : 'text-indigo-700'}">${row.awayOdds ?? '-'}</span>
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        // ====== Correct score ======
        let correctScoreBlock = '';
        const csArr = Array.isArray(m.correct_score_lines) ? m.correct_score_lines : [];
        if (canBet && csArr.length > 0) {
            const filtered = csArr.filter(cs => {
                const parts = cs.score.split(':');
                if (parts.length !== 2) return false;
                const h = parseInt(parts[0], 10);
                const a = parseInt(parts[1], 10);
                return Number.isFinite(h) && Number.isFinite(a) && h <= 3 && a <= 3;
            }).slice(0, 18);

            if (filtered.length > 0) {
                const isOpen = !!(state.expanded.correctScore[m.id]);
                correctScoreBlock = `
                    <div class="mt-3">
                        <button class="w-full flex justify-between items-center text-[13px] font-semibold px-3 py-2 bg-gray-100 rounded-md"
                            onclick="toggleCorrectScore(${m.id})">
                            <span>–°—Ç–∞–≤–∫–∏ –Ω–∞ —Ç–æ—á–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫</span>
                            <span>${isOpen ? '‚ñ≤' : '‚ñº'}</span>
                        </button>
                        ${isOpen ? `
                            <div class="mt-2 grid grid-cols-3 gap-1 text-[11px]">
                                ${filtered.map(cs => `
                                    <button class="bg-gray-50 hover:bg-gray-100 rounded px-1 py-1 border border-gray-200 active:scale-95"
                                        onclick="openBet(${m.id}, '–¢–æ—á–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫', '${cs.score}', ${cs.odds})">
                                        ${cs.score} (${cs.odds})
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        return `
        <div class="bg-white rounded-lg shadow-md p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2 flex-1 justify-center">
                    ${homeLogo ? `<img src="${homeLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
                    <p class="font-bold text-lg">${m.home_team}</p>
                </div>
                <div class="px-4">
                    <p class="text-gray-400">VS</p>
                </div>
                <div class="flex items-center gap-2 flex-1 justify-center">
                    ${awayLogo ? `<img src="${awayLogo}" class="w-8 h-8 rounded-full bg-white border" onerror="this.style.display='none'" />` : ''}
                    <p class="font-bold text-lg">${m.away_team}</p>
                </div>
            </div>

            <div class="text-center text-sm text-gray-500">
                üìÖ ${formatDate(m.match_date)}
            </div>
            ${m.competition ? `
                <div class="text-center text-xs text-gray-400 mt-1 mb-2">
                    üèÜ ${m.competition}
                </div>
            ` : `<div class="mt-2"></div>`}

            ${canBet ? `
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="openBet(${m.id}, '1X2', '–ü1', ${m.odds_home})"
                        class="bg-green-50 hover:bg-green-100 border border-green-200 rounded p-2 active:scale-95">
                        <p class="text-xs text-gray-600">–ü1</p>
                        <p class="font-bold text-green-700">${m.odds_home}</p>
                    </button>
                    <button onclick="openBet(${m.id}, '1X2', 'X', ${m.odds_draw})"
                        class="bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded p-2 active:scale-95">
                        <p class="text-xs text-gray-600">X</p>
                        <p class="font-bold text-blue-700">${m.odds_draw}</p>
                    </button>
                    <button onclick="openBet(${m.id}, '1X2', '–ü2', ${m.odds_away})"
                        class="bg-red-50 hover:bg-red-100 border border-red-200 rounded p-2 active:scale-95">
                        <p class="text-xs text-gray-600">–ü2</p>
                        <p class="font-bold text-red-700">${m.odds_away}</p>
                    </button>
                </div>

                ${doubleChanceRow}
                ${totalsBlock}
                ${handicapsBlock}
                ${correctScoreBlock}
            ` : statusBlock}
        </div>
        `;
    }).join('');
}

function renderBets() {
    if (state.myBets.length === 0) {
        return `
            <div class="bg-white rounded-lg p-8 text-center text-gray-500">
                <p class="text-4xl mb-2">üí∞</p>
                <p>–£ –≤–∞—Å –Ω–µ–º–∞—î —Å—Ç–∞–≤–æ–∫</p>
                <p class="text-sm">–ó—Ä–æ–±—ñ—Ç—å –ø–µ—Ä—à—É!</p>
            </div>
        `;
    }

    return state.myBets.map(b => {
        const colors = {
            pending: 'border-blue-500 bg-blue-50 text-blue-700',
            won: 'border-green-500 bg-green-50 text-green-700',
            lost: 'border-red-500 bg-red-50 text-red-700',
            refund: 'border-yellow-500 bg-yellow-50 text-yellow-700'
        };
        const labels = {
            pending: '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è',
            won: '–í–∏–≥—Ä–∞—à ‚úÖ',
            lost: '–ü—Ä–æ–≥—Ä–∞—à ‚ùå',
            refund: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è'
        };

        const payout =
            b.status === 'won' ? b.potential_win :
            b.status === 'refund' ? b.stake : 0;

        const colorClass = colors[b.status] || 'border-gray-300 bg-gray-50 text-gray-700';
        const label = labels[b.status] || '–°—Ç–∞—Ç—É—Å';

        const m = b.match || null;
        const title = m ? `${m.home_team} ‚Äì ${m.away_team}` : `–ú–∞—Ç—á #${b.match_id}`;
        const comp = m?.competition || null;
        const matchDate = m?.match_date ? formatDate(m.match_date) : null;
        const score =
            m && typeof m.home_score === 'number' && typeof m.away_score === 'number'
                ? `${m.home_score}:${m.away_score}`
                : null;

        return `
            <div class="bg-white rounded-lg shadow p-4 border-l-4 ${colorClass}">
                <div class="flex justify-between items-center mb-2 gap-3">
                    <div>
                        <p class="font-bold text-lg">${title}</p>
                        ${comp ? `<p class="text-xs text-gray-500 mt-1">üèÜ ${comp}</p>` : ''}
                        <p class="text-sm text-gray-600 mt-1">${b.bet_type} - ${b.selection}</p>
                    </div>
                    <span class="inline-flex items-center justify-center h-9 px-3 ${colorClass} rounded text-xs font-bold whitespace-nowrap">
                        ${label}
                    </span>
                </div>

                ${score ? `
                    <p class="text-sm text-gray-600 mb-1">
                        –†–∞—Ö—É–Ω–æ–∫: <span class="font-bold">${score}</span>
                    </p>
                ` : ''}

                <div class="grid grid-cols-3 gap-2 text-sm mt-1">
                    <div>
                        <p class="text-gray-500">–°—Ç–∞–≤–∫–∞</p>
                        <p class="font-bold">${b.stake}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">–ö–æ–µ—Ñ.</p>
                        <p class="font-bold">${b.odds}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">–í–∏–≥—Ä–∞—à</p>
                        <p class="font-bold text-green-600">${payout}</p>
                    </div>
                </div>

                <p class="text-xs text-gray-400 mt-2">
                    –°—Ç–∞–≤–∫–∞: ${formatDate(b.created_at)}
                    ${matchDate ? ` ‚Ä¢ –ú–∞—Ç—á: ${matchDate}` : ''}
                </p>
            </div>
        `;
    }).join('');
}

function renderLeaderboard() {
    return state.leaderboard.map((p, i) => {
        const isMe = state.user && p.username === state.user.telegram_username;
        const colors = ['bg-yellow-400 text-yellow-900', 'bg-gray-300 text-gray-700', 'bg-orange-400 text-orange-900', 'bg-gray-100 text-gray-600'];

        return `
            <div class="bg-white rounded-lg shadow p-4 flex items-center gap-4 ${isMe ? 'border-2 border-red-500' : ''}">
                <div class="w-12 h-12 rounded-full flex items-center justify-center font-bold ${colors[Math.min(i, 3)]}">
                    ${p.rank}
                </div>
                <div class="flex-1">
                    <p class="font-bold">${p.username}</p>
                    <p class="text-sm text-gray-600">–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å: ${p.winRate}%</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-xl text-red-600">${p.points}</p>
                    <p class="text-xs text-gray-500">–±–∞–ª—ñ–≤</p>
                </div>
            </div>
        `;
    }).join('');
}

function renderBetModal() {
    if (!state.selectedMatch) return '';

    const match = state.matches.find(m => m.id === state.selectedMatch);
    if (!match) return '';

    return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModal(event)">
            <div class="bg-white rounded-lg p-6 max-w-md w-full" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-4">–ó—Ä–æ–±–∏—Ç–∏ —Å—Ç–∞–≤–∫—É</h3>

                <div class="bg-gray-50 rounded p-3 mb-4">
                    <p class="text-sm text-gray-600">–ú–∞—Ç—á</p>
                    <p class="font-bold">${match.home_team} vs ${match.away_team}</p>
                    <p class="text-sm text-gray-600 mt-2">–í–∏–±—ñ—Ä</p>
                    <p class="font-bold">${state.betSlip.selection}</p>
                    <p class="text-sm text-gray-600 mt-2">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç</p>
                    <p class="font-bold text-lg text-green-600">${state.betSlip.odds}</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">–°—É–º–∞ —Å—Ç–∞–≤–∫–∏ (–±–∞–ª–∏)</label>
                    <input id="stake" type="number" min="10" max="${state.user.points}" value="${state.betSlip.stake}"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 text-lg"
                        oninput="updateStake(this.value)">
                    <div class="flex gap-2 mt-2">
                        ${[50, 100, 250, 500].map(a => `
                            <button onclick="setStake(${a})" class="flex-1 bg-gray-100 hover:bg-gray-200 rounded py-1 text-sm active:scale-95">${a}</button>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-blue-50 rounded p-3 mb-4">
                    <p class="text-sm text-gray-600">–ú–æ–∂–ª–∏–≤–∏–π –≤–∏–≥—Ä–∞—à</p>
                    <p class="text-2xl font-bold text-blue-600" id="win">${(state.betSlip.stake * state.betSlip.odds).toFixed(0)}</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="state.selectedMatch = null; render()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 font-semibold py-3 rounded-lg active:scale-95">
                        –°–∫–∞—Å—É–≤–∞—Ç–∏
                    </button>
                    <button onclick="placeBet()"
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg active:scale-95">
                        –ü–æ—Å—Ç–∞–≤–∏—Ç–∏
                    </button>
                </div>
            </div>
        </div>
    `;
}

// ‚úÖ FAB + Referral Sheet
function renderReferralFab() {
    if (!state.user) return '';

    const needsVerify = !!(state.user.referrer_id && state.user.referral_rewarded === false);

    return `
        <div class="fab">
            <button onclick="openReferral()"
                class="relative w-14 h-14 rounded-full shadow-xl bg-gradient-to-br from-red-600 to-red-700 text-white flex items-center justify-center active:scale-95">
                <span class="text-2xl">üéÅ</span>
                ${needsVerify ? `
                    <span class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-white text-red-700 text-[11px] font-bold flex items-center justify-center border border-red-200">
                        !
                    </span>
                ` : ''}
            </button>
        </div>
    `;
}

function renderReferralSheet() {
    if (!state.referral.open) return '';

    const tab = state.referral.tab;
    const loading = state.referral.loading;

    const inviteHint = `
        <div class="text-sm text-gray-600">
            <p class="font-semibold text-gray-800 mb-1">–ó–∞–ø—Ä–æ—Å–∏ –¥—Ä—É–≥–∞ —ñ –æ—Ç—Ä–∏–º–∞–π –±–æ–Ω—É—Å</p>
            <p>–ö–æ–ª–∏ –¥—Ä—É–≥ –∑–∞–π–¥–µ –ø–æ —Ç–≤–æ—î–º—É –ª—ñ–Ω–∫—É —Ç–∞ –ø—ñ–¥–ø–∏—à–µ—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª ‚Äî —Ç–æ–±—ñ –Ω–∞—Ä–∞—Ö—É—é—Ç—å <span class="font-bold text-red-600">+50</span> –±–∞–ª—ñ–≤.</p>
        </div>
    `;

    const lastLinkBlock = state.referral.lastLink ? `
        <div class="mt-3 bg-gray-50 border border-gray-200 rounded-lg p-3">
            <p class="text-xs text-gray-500 mb-1">–û—Å—Ç–∞–Ω–Ω—ñ–π —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫</p>
            <div class="text-[12px] font-mono break-all text-gray-800">${state.referral.lastLink}</div>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <button onclick="copyRef('${state.referral.lastLink}')"
                    class="bg-white border border-gray-200 rounded-md py-2 text-sm active:scale-95">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                <button onclick="shareRef('${state.referral.lastLink}')"
                    class="bg-red-600 text-white rounded-md py-2 text-sm active:scale-95">üöÄ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
            </div>
        </div>
    ` : '';

    const verifyBlock = (state.user && state.user.referrer_id && state.user.referral_rewarded === false) ? `
        <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
            <p class="text-sm text-yellow-800 font-semibold">–£ –≤–∞—Å —î –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è üéØ</p>
            <p class="text-xs text-yellow-700 mt-1">–Ø–∫—â–æ –≤–∏ –≤–∂–µ –ø—ñ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –Ω–∞—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–æ–Ω—É—Å –∑–∞–ø—Ä–æ—à—É–≤–∞—á—É.</p>
            <button onclick="refVerify()"
                class="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white rounded-md py-2 text-sm font-semibold active:scale-95">
                ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É
            </button>
        </div>
    ` : '';

    const codesList = `
        <div class="mt-3 space-y-2">
            ${state.referral.codes.length === 0 ? `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-600 text-center">
                    –£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∫–æ–¥—ñ–≤. –°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à–∏–π —É –≤–∫–ª–∞–¥—Ü—ñ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏.
                </div>
            ` : state.referral.codes.map(r => {
                const isClaimed = !!r.invited_id;
                const isRewarded = !!r.rewarded;
                const status = isRewarded
                    ? `<span class="text-[11px] px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">–ù–∞–≥–æ—Ä–æ–¥–∂–µ–Ω–æ</span>`
                    : isClaimed
                        ? `<span class="text-[11px] px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">–ó–∞–π–Ω—è—Ç–æ</span>`
                        : `<span class="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700 font-semibold">–í—ñ–ª—å–Ω–∏–π</span>`;

                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0">
                                <p class="text-xs text-gray-500">–ö–æ–¥</p>
                                <p class="font-mono text-sm text-gray-900 break-all">${r.code}</p>
                            </div>
                            <div>${status}</div>
                        </div>

                        <div class="mt-2 text-xs text-gray-500 break-all">
                            ${r.link}
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button onclick="copyRef('${r.link}')" class="bg-gray-100 hover:bg-gray-200 rounded-md py-2 text-sm active:scale-95">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                            <button onclick="shareRef('${r.link}')" class="bg-red-600 text-white rounded-md py-2 text-sm active:scale-95">üöÄ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
                        </div>

                        <div class="mt-2 text-[11px] text-gray-400">
                            ${r.claimed_at ? `–ë—Ä–æ–Ω—å: ${formatDate(r.claimed_at)}` : '–©–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ'}
                            ${r.rewarded_at ? ` ‚Ä¢ –ë–æ–Ω—É—Å: ${formatDate(r.rewarded_at)}` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;

    return `
        <div class="sheet">
            <div class="fixed inset-0 bg-black/40" onclick="closeReferral()"></div>

            <div class="sheet-panel bg-white shadow-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <p class="text-lg font-bold">üéÅ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è</p>
                        <p class="text-xs text-gray-500">–ö–æ–¥–∏: ${state.referral.codes.length}/${state.referral.max}</p>
                    </div>
                    <button onclick="closeReferral()"
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center active:scale-95">‚úï</button>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="refTab('invite')"
                        class="py-2 rounded-lg text-sm font-semibold active:scale-95 ${
                            tab === 'invite' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'
                        }">
                        –ó–∞–ø—Ä–æ—Å–∏—Ç–∏
                    </button>
                    <button onclick="refTab('mycodes')"
                        class="py-2 rounded-lg text-sm font-semibold active:scale-95 ${
                            tab === 'mycodes' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'
                        }">
                        –ú–æ—ó –∫–æ–¥–∏
                    </button>
                </div>

                ${loading ? `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-sm text-gray-600">
                        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                    </div>
                ` : ''}

                ${tab === 'invite' ? `
                    ${inviteHint}

                    <button onclick="refCreate()"
                        class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white rounded-lg py-3 font-semibold active:scale-95">
                        ‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫
                    </button>

                    ${lastLinkBlock}
                    ${verifyBlock}
                ` : `
                    ${codesList}
                `}

                <div class="h-2"></div>
                <div class="safe-bottom"></div>
            </div>
        </div>
    `;
}

function renderNav() {
    const pages = [
        { id: 'matches', icon: 'üìä', label: '–ú–∞—Ç—á—ñ' },
        { id: 'bets', icon: 'üí∞', label: '–°—Ç–∞–≤–∫–∏' },
        { id: 'leaderboard', icon: 'üèÜ', label: '–†–µ–π—Ç–∏–Ω–≥' }
    ];

    return `
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t px-2 py-2 safe-bottom z-40">
            <div class="grid grid-cols-3 gap-2">
                ${pages.map(p => `
                    <button onclick="changePage('${p.id}')"
                        class="flex flex-col items-center py-2 rounded-lg active:scale-95 ${
                            state.currentPage === p.id ? 'bg-red-50 text-red-600' : 'text-gray-600'
                        }">
                        <span class="text-2xl mb-1">${p.icon}</span>
                        <span class="text-xs font-medium">${p.label}</span>
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

function render() {
    const app = document.getElementById('app');

    if (state.loading) {
        app.innerHTML = `
            <div class="flex items-center justify-center min-h-screen">
                <div class="text-center">
                    <div class="loading text-6xl mb-4">‚öΩ</div>
                    <p class="text-gray-600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                </div>
            </div>
        `;
        return;
    }

    let content = '';
    if (state.currentPage === 'matches') {
        content = `
            <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-lg p-4 text-white mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
                        <p class="text-3xl font-bold">${state.user.points}</p>
                    </div>
                    <div class="text-5xl">üèÜ</div>
                </div>
            </div>
            <h2 class="text-xl font-bold mb-4">‚è∞ –ú–∞–π–±—É—Ç–Ω—ñ –º–∞—Ç—á—ñ</h2>
            <div class="space-y-4">${renderMatches()}</div>
        `;
    } else if (state.currentPage === 'bets') {
        content = `<h2 class="text-xl font-bold mb-4">üìã –ú–æ—ó —Å—Ç–∞–≤–∫–∏</h2><div class="space-y-4">${renderBets()}</div>`;
    } else if (state.currentPage === 'leaderboard') {
        content = `<h2 class="text-xl font-bold mb-4">üëë –†–µ–π—Ç–∏–Ω–≥</h2><div class="space-y-4">${renderLeaderboard()}</div>`;
    }

    app.innerHTML = `
        ${renderHeader()}
        <div class="p-4 pb-24">${content}</div>

        ${renderNav()}
        ${renderReferralFab()}
        ${renderReferralSheet()}
        ${renderBetModal()}
    `;
}

// ==========================================
// –ì–õ–û–ë–ê–õ–¨–ù–Ü –§–£–ù–ö–¶–Ü–á
// ==========================================
window.changePage = async (page) => {
    state.currentPage = page;
    if (tg) tg.HapticFeedback.impactOccurred('light');
    if (page === 'bets') await loadMyBets();
    if (page === 'leaderboard') await loadLeaderboard();
    render();
};

window.openBet = (matchId, type, selection, odds) => {
    state.selectedMatch = matchId;
    state.betSlip = { matchId, type, selection, odds, stake: 50 };
    if (tg) tg.HapticFeedback.impactOccurred('medium');
    render();
};

window.closeModal = (e) => {
    if (e.target === e.currentTarget) {
        state.selectedMatch = null;
        render();
    }
};

window.updateStake = (val) => {
    state.betSlip.stake = parseInt(val) || 0;
    const win = (state.betSlip.stake * state.betSlip.odds).toFixed(0);
    document.getElementById('win').textContent = win;
};

window.setStake = (amt) => {
    state.betSlip.stake = amt;
    document.getElementById('stake').value = amt;
    updateStake(amt);
    if (tg) tg.HapticFeedback.impactOccurred('light');
};

window.toggleTotals = (matchId) => {
    state.expanded.totals[matchId] = !state.expanded.totals[matchId];
    render();
};

window.toggleHandicaps = (matchId) => {
    state.expanded.handicaps[matchId] = !state.expanded.handicaps[matchId];
    render();
};

window.toggleCorrectScore = (matchId) => {
    state.expanded.correctScore[matchId] = !state.expanded.correctScore[matchId];
    render();
};

// ‚úÖ Referral globals
window.openReferral = async () => {
    state.referral.open = true;
    if (tg) tg.HapticFeedback.impactOccurred('light');
    try {
        state.referral.loading = true;
        render();
        await loadReferralCodes();
    } finally {
        state.referral.loading = false;
        render();
    }
};

window.closeReferral = () => {
    state.referral.open = false;
    render();
};

window.refTab = async (tab) => {
    state.referral.tab = tab;
    if (tg) tg.HapticFeedback.impactOccurred('light');
    // –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ "–ú–æ—ó –∫–æ–¥–∏" ‚Äî –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫
    if (tab === 'mycodes') {
        state.referral.loading = true;
        render();
        try { await loadReferralCodes(); }
        finally { state.referral.loading = false; render(); }
    } else {
        render();
    }
};

window.refCreate = async () => {
    if (tg) tg.HapticFeedback.impactOccurred('medium');
    await createReferralCode();
};

window.copyRef = async (link) => {
    await copyText(link);
};

window.shareRef = (link) => {
    shareLink(link);
};

window.refVerify = async () => {
    if (tg) tg.HapticFeedback.impactOccurred('medium');
    await verifyReferralReward();
};

// ==========================================
// –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
// ==========================================
async function init() {
    try {
        state.loading = true;
        render();

        await loadUser();
        await loadMatches();

        state.loading = false;
        render();

    } catch (error) {
        console.error('Init error:', error);
        state.loading = false;
        document.getElementById('app').innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="text-center">
                    <p class="text-6xl mb-4">‚ùå</p>
                    <p class="text-xl font-bold mb-2">–ü–æ–º–∏–ª–∫–∞</p>
                    <p class="text-gray-600 mb-4">${error.message}</p>
                    <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg">
                        –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
                    </button>
                </div>
            </div>
        `;
    }
}

init();
</script>
</body>
</html>
